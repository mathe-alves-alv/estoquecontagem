<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Contagem de Estoque v10.4 (Filtros de Produto)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #007bff; --success-color: #198754; --info-color: #0dcaf0; --danger-color: #dc3545; --background-color: #f4f6f9; --container-bg-color: #ffffff; --text-color: #212529; --border-color: #dee2e6; --border-radius: 0.375rem; --box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 10px 0; background-color: var(--background-color); color: var(--text-color); display: flex; flex-direction: column; align-items: center; min-height: 100vh; font-size: 16px; }
        .container { width: 95%; max-width: 800px; background-color: var(--container-bg-color); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); margin: 15px 0; border: 1px solid var(--border-color); }
        h1, h2, h3 { text-align: center; margin-top: 0; margin-bottom: 1.5rem; font-weight: 500; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeInView .4s; }
        @keyframes fadeInView { from { opacity: 0; } to { opacity: 1; } }
        button, .btn { border: 1px solid transparent; padding: .6rem 1rem; font-size: 1rem; border-radius: var(--border-radius); cursor: pointer; transition: background-color .15s; margin: .25rem; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-info { background-color: var(--info-color); color: black; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .dashboard-options { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; padding: 1rem 0; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        th, td { border: 1px solid var(--border-color); padding: .6rem; text-align: left; word-break: break-word; }
        th { background-color: #f8f9fa; }
        input, select { width: 100%; padding: .7rem .75rem; margin-bottom: 1rem; border: 1px solid #ced4da; border-radius: var(--border-radius); box-sizing: border-box; font-size: 16px; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: .5rem; font-weight: 500; }
        .card { border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: 1.5rem; box-shadow: var(--box-shadow); }
        .card-header { padding: .75rem 1.25rem; background-color: #f8f9fa; border-bottom: 1px solid var(--border-color); }
        .card-header h3 { margin: 0; font-size: 1.25rem; }
        .card-body { padding: 1.25rem; overflow-x: auto; }
        .form-inline { display: flex; gap: 1rem; align-items: flex-end; }
        #loginErrorMessage { color: var(--danger-color); margin-top: 1rem; text-align: center; display: none; }
        .table-actions button { margin: 0 2px; padding: .25rem .5rem; font-size: .85rem; }
        .back-button { margin-bottom: 1.5rem; display: inline-block; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal-content { background-color: white; padding: 25px; border-radius: var(--border-radius); width: 90%; max-width: 500px; }
        .modal-actions { margin-top: 1.5rem; text-align: right; }
        .setores-checkbox-group { max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: var(--border-radius); margin-bottom: 1rem; }
        .setores-checkbox-group label { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; }
        .setores-checkbox-group input[type="checkbox"] { width: auto; margin-bottom: 0; }
        .admin-only { display: none; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .login-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        .tab-button { flex: 1; padding: 0.75rem; border: none; background-color: transparent; cursor: pointer; font-size: 1.1rem; border-bottom: 3px solid transparent; }
        .tab-button.active { border-bottom-color: var(--primary-color); font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .input-quantidade {
            padding: .8rem .5rem !important;
            font-size: 1.1rem;
            text-align: center;
            width: 100px; 
            min-width: 80px;
        }

        #tableContagem th:nth-child(2),
        #tableContagem td:nth-child(2) {
            font-size: 0.9rem;
            white-space: nowrap;
            word-break: keep-all;
            text-align: center;
            padding-left: 4px;
            padding-right: 4px;
        }
        #tableContagem th:nth-child(3) {
             text-align: center;
        }

        #tableProdutos th, #tableProdutos td,
        #tableUsuarios th, #tableUsuarios td,
        #tableCategorias th, #tableCategorias td,
        #tableSetores th, #tableSetores td,
        #tableHistorico th, #tableHistorico td,
        #tableContagemFinalizada th, #tableContagemFinalizada td {
            white-space: nowrap;
            vertical-align: middle;
        }
        
        .table-actions {
            display: flex;
            flex-wrap: nowrap;
            gap: 5px;
            align-items: center;
        }

        @media (max-width: 600px) {
            .dashboard-options { grid-template-columns: 1fr; }
            .form-inline { flex-direction: column; align-items: stretch; }
        }

        @media (max-width: 768px) {
            body { padding: 0; }
            .container {
                width: 100%;
                max-width: 100%;
                margin: 0;
                padding: 15px;
                border: none;
                border-radius: 0;
                box-shadow: none;
                min-height: 100vh;
                box-sizing: border-box;
            }
            input, select, button, .btn {
                padding: .8rem 1rem;
                font-size: 16px;
            }
            input[type="search"] {
                -webkit-appearance: none;
                appearance: none;
                padding: .8rem 1rem;
            }
             .table-actions button {
                padding: .6rem 1rem;
            }
        }
    </style>
</head>

<body>
    <div id="mainContainer" class="container">
        <div id="loader" class="loader"></div>
        
        <div id="screenLogin" class="screen active">
            </div>

        <div id="appContent" style="display: none;">
            
            <div id="screenDashboard" class="screen">
                </div>
            
            <div id="screenUsuarios" class="screen">
                </div>

            <div id="screenProdutos" class="screen">
                <button class="btn btn-secondary back-button btn-back" data-target="screenDashboard">&larr; Voltar</button>
                <h2>Gerenciar Produtos</h2>
                
                <div class="card">
                    <div class="card-header"><h3>Adicionar Novo Produto</h3></div>
                    <div class="card-body">
                        <form id="formAddProduto">
                            <div class="form-group"><label for="produtoCodigo">C칩digo:</label><input type="text" id="produtoCodigo" required></div>
                            <div class="form-group"><label for="produtoNome">Nome do Produto:</label><input type="text" id="produtoNome" required></div>
                            <div class="form-group"><label for="produtoCategoria">Categoria:</label><select id="produtoCategoria" required></select></div>
                            <div class="form-group"><label for="produtoSetor">Setor:</label><select id="produtoSetor" required></select></div>
                            <button type="submit" class="btn btn-success">Adicionar Produto</button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Filtrar Produtos</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="filtroProdutoNome">Buscar por Nome:</label>
                            <input type="search" id="filtroProdutoNome" placeholder="Digite o nome do produto..." autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label for="filtroProdutoCategoria">Filtrar por Categoria:</label>
                            <select id="filtroProdutoCategoria"></select>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Produtos Cadastrados</h3></div>
                    <div class="card-body">
                        <table id="tableProdutos">
                            <thead><tr><th>C칩digo</th><th>Nome</th><th>Categoria</th><th>Setor</th><th>A칞칚o</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="screenCategorias" class="screen">
                </div>

            <div id="screenSetores" class="screen">
                </div>

            <div id="screenNovaContagem" class="screen">
                </div>

            <div id="screenHistorico" class="screen">
                </div>

            <div id="screenVisualizarContagem" class="screen">
                </div>
        </div>
    </div>
    
    <div id="modalEditProduto" class="modal-overlay">
        </div>

    <template id="template-linha-simples"><tr><td></td><td class="table-actions"><button class="btn btn-danger btn-deletar">Excluir</button></td></tr></template>
    <template id="template-linha-produto"><tr><td></td><td></td><td></td><td></td><td class="table-actions"><button class="btn btn-info btn-editar">Editar</button><button class="btn btn-danger btn-deletar">Excluir</button></td></tr></template>
    <template id="template-linha-historico"><tr><td></td><td></td><td></td><td></td><td class="table-actions"><button class="btn btn-primary btn-visualizar">Visualizar</button><button class="btn btn-success btn-exportar">Baixar TXT</button></td></tr></template>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {

        const SUPABASE_URL = 'https://ceubvhjwalylsfwuwezb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNldWJ2aGp3YWx5bHNmd3V3ZXpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4ODc4NDYsImV4cCI6MjA3NjQ2Mzg0Nn0.edAsL7rWed0jXCcNLy8oKDKsI5FfSY8r_fXyXRWrzso';
        const { createClient } = supabase;
        const _supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const CONTADOR_SECRET_PASSWORD = 'SenhaSuperSecretaParaContadores123';
        
        let currentUserProfile = null;
        let usersCache = [], categoriasCache = [], setoresCache = [], produtosCache = [];
        let draftQuantities = new Map(); 
        const DRAFT_KEY = 'draftContagem'; 
        const SCREEN_KEY = 'currentScreen'; 
        const loader = document.getElementById('loader');

        const showLoader = () => loader.style.display = 'block';
        const hideLoader = () => loader.style.display = 'none';

        const showScreen = (screenId) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId)?.classList.add('active');
            window.scrollTo(0, 0);
            if (screenId !== 'screenLogin') {
                localStorage.setItem(SCREEN_KEY, screenId);
            }
        };
        
        const loginTabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        let activeLoginTab = 'contador'; 
        loginTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                loginTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                activeLoginTab = tab.dataset.tab;
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id.toLowerCase() === `tab${activeLoginTab}`) {
                        content.classList.add('active');
                    }
                });
                document.getElementById('loginErrorMessage').style.display = 'none';
            });
        });

        const handleLogin = async () => {
            showLoader();
            const loginErrorMessage = document.getElementById('loginErrorMessage');
            loginErrorMessage.style.display = 'none';
            let email, password;
            if (activeLoginTab === 'contador') {
                email = document.getElementById('loginEmailContador').value.trim();
                password = CONTADOR_SECRET_PASSWORD; 
            } else {
                email = document.getElementById('loginEmailAdmin').value.trim();
                password = document.getElementById('loginPasswordAdmin').value;
            }
            if (!email) {
                loginErrorMessage.textContent = 'O campo de email 칠 obrigat칩rio.';
                loginErrorMessage.style.display = 'block';
                hideLoader();
                return;
            }
            try {
                const { data, error } = await _supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                if (data.user) {
                    await initializeApp(data.user);
                }
            } catch (error) {
                console.error('Login error:', error);
                loginErrorMessage.textContent = 'Credenciais inv치lidas.';
                loginErrorMessage.style.display = 'block';
            } finally {
                hideLoader();
            }
        };

        const handleLogout = async () => {
            showLoader();
            await _supabaseClient.auth.signOut();
            currentUserProfile = null;
            
            localStorage.removeItem(DRAFT_KEY);
            localStorage.removeItem(SCREEN_KEY);

            document.getElementById('appContent').style.display = 'none';
            document.getElementById('loginEmailContador').value = '';
            document.getElementById('loginEmailAdmin').value = '';
            document.getElementById('loginPasswordAdmin').value = '';
            showScreen('screenLogin');
            hideLoader();
        };
        
        const initializeApp = async (user) => {
            showLoader();
            try {
                const { data: profile, error: profileError } = await _supabaseClient.from('profiles').select('*').eq('id', user.id).single();
                if (profileError) throw profileError;
                currentUserProfile = profile;
                
                const { data: setoresPermitidos, error: setoresError } = await _supabaseClient.from('profile_setores').select('setor_id').eq('profile_id', user.id);
                if (setoresError) throw setoresError;
                currentUserProfile.setorIds = setoresPermitidos.map(s => s.setor_id);

                document.getElementById('userDisplay').textContent = `${profile.nome} (${profile.role})`;
                
                await Promise.all([
                    loadDataToCache('categorias'),
                    loadDataToCache('setores'),
                    loadDataToCache('produtos'),
                    loadUsersCache()
                ]);
                
                updateUIForRole();
                document.getElementById('appContent').style.display = 'block';
                
                const lastScreen = localStorage.getItem(SCREEN_KEY) || 'screenDashboard';

                // --- 游 ATUALIZADO 游 ---
                // Adiciona a prepara칞칚o da tela de produtos
                switch (lastScreen) {
                    case 'screenNovaContagem':
                        startNewCount();
                        break;
                    case 'screenHistorico':
                        await renderHistoricoTable(); 
                        break;
                    case 'screenProdutos':
                        renderProdutoTable();
                        populateCategoriaDropdown(document.getElementById('produtoCategoria'));
                        populateSetorDropdown(document.getElementById('produtoSetor'));
                        // --- 游 NOVO 游 ---
                        // Popula os filtros da tela de produtos
                        const catFiltroSelect = document.getElementById('filtroProdutoCategoria');
                        populateCategoriaDropdown(catFiltroSelect);
                        catFiltroSelect.insertAdjacentHTML("afterbegin", '<option value="todos" selected>Todas as Categorias</option>');
                        document.getElementById('filtroProdutoNome').value = ""; 
                        // --- FIM DO NOVO ---
                        break;
                    case 'screenCategorias':
                        renderSimpleTable('categorias', categoriasCache, document.getElementById('tableCategorias').querySelector('tbody'));
                        break;
                    case 'screenSetores':
                        renderSimpleTable('setores', setoresCache, document.getElementById('tableSetores').querySelector('tbody'));
                        break;
                    case 'screenUsuarios':
                        if(currentUserProfile.role === 'admin') {
                            await loadUsersCache(); 
                            renderUsuarioTable();
                            populateSetorCheckboxes(document.getElementById('usuarioSetores'));
                        }
                        break;
                }
                
                showScreen(lastScreen);

            } catch (error) {
                 console.error("Erro ao inicializar:", error);
                 alert("N칚o foi poss칤vel carregar seu perfil. Tente logar novamente.");
                 await handleLogout();
            } finally {
                hideLoader();
            }
        };

        const updateUIForRole = () => {
            const isAdmin = currentUserProfile && currentUserProfile.role === "admin";
            document.querySelectorAll(".admin-only").forEach(el => {
                el.style.display = isAdmin ? "block" : "none";
            });
        };

        const loadDataToCache = async (entity) => {
            try {
                const { data, error } = await _supabaseClient.from(entity).select('*');
                if (error) throw error;
                if (entity === 'categorias') categoriasCache = data;
                else if (entity === 'setores') setoresCache = data;
                else if (entity === 'produtos') produtosCache = data;
            } catch (error) { console.error(`Error loading ${entity}:`, error); }
        };

        const loadUsersCache = async () => {
            if(!currentUserProfile || currentUserProfile.role !== 'admin') return;
            try {
                const { data, error } = await _supabaseClient.rpc('get_profiles_with_sectors'); 
                if (error) throw error;
                usersCache = data;
            } catch (error) { console.error(`Error loading users:`, error); }
        };

        document.getElementById('formAddUsuario').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nome = document.getElementById('usuarioNome').value.trim();
            const email = document.getElementById('usuarioEmail').value.trim();
            const setoresSelecionados = [...document.querySelectorAll('#usuarioSetores input:checked')].map(cb => cb.value);

            if (!nome || !email || setoresSelecionados.length === 0) {
                alert('Por favor, preencha nome, email e selecione ao menos um setor.');
                return;
            }
            
            showLoader();
            try {
                const { data, error } = await _supabaseClient.functions.invoke('create-user', {
                    body: { email: email, nome: nome, setores: setoresSelecionados }
                });

                if (error) throw error; 
                
                alert('Contador criado com sucesso!');
                e.target.reset(); 
                await loadUsersCache();
                renderUsuarioTable();

            } catch (error) {
                let errorMessage = error.message;
                try {
                    const errorBody = await error.context.json();
                    if (errorBody && errorBody.error) {
                        errorMessage = errorBody.error;
                    }
                } catch (parseError) { }
                alert(`Erro ao criar contador: ${errorMessage}`);
                console.error(error);
            } finally {
                hideLoader();
            }
        });
        
        const renderUsuarioTable = () => {
            const tableBody = document.getElementById("tableUsuarios").querySelector("tbody");
            tableBody.innerHTML = "";
            if (usersCache.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5">Nenhum usu치rio cadastrado.</td></tr>`;
                return;
            }

            usersCache.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(user => {
                if (user.id === currentUserProfile.id) return;
                
                const row = tableBody.insertRow();
                const setores = (user.sectors && user.sectors.length > 0) ? user.sectors.map(s => s.nome).join(', ') : 'Nenhum';
                row.innerHTML = `
                    <td>${user.nome}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td>
                    <td>${setores}</td>
                    <td class="table-actions">
                        <button class="btn btn-danger btn-deletar-usuario" data-id="${user.id}" data-email="${user.email}">Excluir</button>
                    </td>
                `;
            });
            
            document.querySelectorAll('.btn-deletar-usuario').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopImmediatePropagation(); 
                    const userId = button.dataset.id;
                    const userEmail = button.dataset.email;
                    handleDeleteUser(userId, userEmail);
                });
            });
        };

        const handleDeleteUser = async (userId, userEmail) => {
            if (!confirm(`Tem certeza que deseja excluir permanentemente o usu치rio "${userEmail}"?`)) {
                return;
            }
            
            showLoader();
            try {
                const { data, error } = await _supabaseClient.functions.invoke('delete-user', {
                    body: { user_id: userId }
                });
                
                if (error) throw error; 

                alert('Usu치rio exclu칤do com sucesso!');
                
                await loadUsersCache();
                renderUsuarioTable();

            } catch (error) {
                let errorMessage = error.message;
                try {
                    const errorBody = await error.context.json();
                    if (errorBody && errorBody.error) {
                        errorMessage = errorBody.error;
                    }
                } catch (parseError) { }
                alert(`Erro ao excluir usu치rio: ${errorMessage}`);
                console.error(error);
            } finally {
                hideLoader();
            }
        };

        const populateSetorCheckboxes = (container) => {
            container.innerHTML = '';
            setoresCache.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(setor => {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" value="${setor.id}"> ${setor.nome}`;
                container.appendChild(label);
            });
        };

        const renderSimpleTable = (entity, data, tableBody) => {
            const template = document.getElementById('template-linha-simples');
            tableBody.innerHTML = '';
            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="2">Nenhum item cadastrado.</td></tr>`;
                return;
            }
            data.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(item => {
                const clone = template.content.cloneNode(true);
                clone.querySelector('td').textContent = item.nome; 
                clone.querySelector('.btn-deletar').addEventListener('click', async () => {
                    if (confirm(`Tem certeza que deseja excluir "${item.nome}"?`)) {
                        showLoader();
                        try {
                            const { error } = await _supabaseClient.from(entity).delete().eq('id', item.id);
                            if (error) throw error;
                            await loadDataToCache(entity);
                            renderSimpleTable(entity, (entity === 'categorias' ? categoriasCache : setoresCache), tableBody);
                        } catch (error) { alert(`Erro ao excluir: ${error.message}`); } finally { hideLoader(); }
                    }
                });
                tableBody.appendChild(clone);
            });
        };

        // --- 游 FUN칂츾O ATUALIZADA 游 ---
        // Adiciona 'data-categoria-id'  linha
        const renderProdutoTable = () => {
            const tableBody = document.getElementById("tableProdutos").querySelector("tbody");
            const template = document.getElementById("template-linha-produto");
            tableBody.innerHTML = "";
            if (produtosCache.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5">Nenhum produto cadastrado.</td></tr>`;
                return;
            }
            produtosCache.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(prod => {
                const categoria = categoriasCache.find(c => c.id === prod.categoria_id);
                const setor = setoresCache.find(s => s.id === prod.setor_id);
                const clone = template.content.cloneNode(true);
                
                // Adiciona o ID da categoria ao 'tr' para o filtro funcionar
                clone.querySelector('tr').dataset.categoriaId = prod.categoria_id;
                
                const cells = clone.querySelectorAll('td');
                cells[0].textContent = prod.codigo;
                cells[1].textContent = prod.nome;
                cells[2].textContent = categoria ? categoria.nome : "N/A";
                cells[3].textContent = setor ? setor.nome : "N/A";
                clone.querySelector(".btn-editar").addEventListener("click", () => openEditModal(prod.id));
                clone.querySelector(".btn-deletar").addEventListener("click", async () => {
                    if (confirm(`Tem certeza que deseja excluir o produto "${prod.nome}"?`)) {
                        showLoader();
                        try {
                            const { error } = await _supabaseClient.from("produtos").delete().eq("id", prod.id);
                            if (error) throw error;
                            await loadDataToCache("produtos");
                            renderProdutoTable(); // Re-renderiza a tabela
                            applyProdutoFilters(); // Aplica os filtros novamente
                        } catch (error) { alert(`Erro ao excluir produto: ${error.message}`); } finally { hideLoader(); }
                    }
                });
                tableBody.appendChild(clone);
            });
        };

        const renderHistoricoTable = async () => {
            const tableBody = document.getElementById("tableHistorico").querySelector("tbody");
            const template = document.getElementById("template-linha-historico");
            tableBody.innerHTML = ""; // Limpa a tabela
            
            showLoader();
            try {
                const { data: contagens, error } = await _supabaseClient.from("contagens").select("*").order("created_at", { ascending: false });
                if (error) throw error;

                if (contagens.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5">Nenhuma contagem registrada para seus setores.</td></tr>`;
                    return;
                }
                contagens.forEach(contagem => {
                    const clone = template.content.cloneNode(true);
                    const cells = clone.querySelectorAll('td');
                    cells[0].textContent = new Date(contagem.created_at).toLocaleString("pt-BR");
                    cells[1].textContent = contagem.responsavel_nome;
                    cells[2].textContent = contagem.setor_nome;
                    cells[3].textContent = contagem.itens.length;
                    clone.querySelector(".btn-visualizar").addEventListener("click", () => showCountDetails(contagem.id));
                    clone.querySelector(".btn-exportar").addEventListener("click", () => handleExportTXT(contagem.id));
                    tableBody.appendChild(clone);
                });
            } catch (error) { alert(`Erro ao carregar hist칩rico: ${error.message}`); } finally { hideLoader(); }
        };

        const populateDropdown = (selectElement, data, placeholder) => {
            selectElement.innerHTML = `<option value="">-- ${placeholder} --</option>`;
            data.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(item => {
                selectElement.innerHTML += `<option value="${item.id}">${item.nome}</option>`;
            });
        };
        const populateCategoriaDropdown = (elem) => populateDropdown(elem, categoriasCache, "Selecione a Categoria");
        const populateSetorDropdown = (elem) => populateDropdown(elem, setoresCache, "Selecione o Setor");

        const setupSimpleForm = (formId, inputId, entity, tableBody) => {
            document.getElementById(formId).addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = document.getElementById(inputId);
                const nome = input.value.trim();
                if (!nome) return;
                const cache = (entity === 'categorias' ? categoriasCache : setoresCache);
                if (cache.some(item => item.nome.toLowerCase() === nome.toLowerCase())) {
                    alert(`O item "${nome}" j치 est치 cadastrado.`);
                    return;
                }
                showLoader();
                try {
                    const { error } = await _supabaseClient.from(entity).insert({ nome });
                    if (error) throw error;
                    input.value = '';
                    await loadDataToCache(entity);
                    renderSimpleTable(entity, (entity === 'categorias' ? categoriasCache : setoresCache), tableBody);
                } catch (error) { alert(`Erro ao adicionar: ${error.message}`); } finally { hideLoader(); }
            });
        };

        document.getElementById("formAddProduto").addEventListener("submit", async e => {
            e.preventDefault();
            const codigo = document.getElementById("produtoCodigo").value.trim();
            const nome = document.getElementById("produtoNome").value.trim();
            const categoria_id = document.getElementById("produtoCategoria").value;
            const setor_id = document.getElementById("produtoSetor").value;
            if (!codigo || !nome || !categoria_id || !setor_id) return alert("Todos os campos s칚o obrigat칩rios.");
            if (produtosCache.some(p => p.codigo.toLowerCase() === codigo.toLowerCase())) return alert(`O c칩digo "${codigo}" j치 est치 cadastrado.`);
            showLoader();
            try {
                const { error } = await _supabaseClient.from("produtos").insert({ codigo, nome, categoria_id, setor_id });
                if (error) throw error;
                e.target.reset();
                await loadDataToCache("produtos");
                renderProdutoTable();
            } catch (error) { alert(`Erro ao adicionar produto: ${error.message}`); } finally { hideLoader(); }
        });

        document.getElementById("formEditProduto").addEventListener("submit", async e => {
            e.preventDefault();
            const id = document.getElementById("editProdutoId").value;
            const codigo = document.getElementById("editProdutoCodigo").value.trim();
            const nome = document.getElementById("editProdutoNome").value.trim();
            const categoria_id = document.getElementById("editProdutoCategoria").value;
            const setor_id = document.getElementById("editProdutoSetor").value;
            if (!codigo || !nome || !categoria_id || !setor_id) return alert("Todos os campos s칚o obrigat칩rios.");
            if (produtosCache.some(p => p.codigo.toLowerCase() === codigo.toLowerCase() && p.id != id)) return alert(`O c칩digo "${codigo}" j치 pertence a outro produto.`);
            showLoader();
            try {
                const { error } = await _supabaseClient.from("produtos").update({ codigo, nome, categoria_id, setor_id }).eq("id", id);
                if (error) throw error;
                await loadDataToCache("produtos");
                renderProdutoTable();
                closeEditModal();
            } catch (error) { alert(`Erro ao atualizar produto: ${error.message}`); } finally { hideLoader(); }
        });
        
        const modal = document.getElementById("modalEditProduto");
        const openEditModal = (produtoId) => {
            const produto = produtosCache.find(p => p.id === produtoId);
            if (!produto) return;
            populateCategoriaDropdown(document.getElementById("editProdutoCategoria"));
            populateSetorDropdown(document.getElementById("editProdutoSetor"));
            document.getElementById("editProdutoId").value = produto.id;
            document.getElementById("editProdutoCodigo").value = produto.codigo;
            document.getElementById("editProdutoNome").value = produto.nome;
            document.getElementById("editProdutoCategoria").value = produto.categoria_id;
            document.getElementById("editProdutoSetor").value = produto.setor_id;
            modal.classList.add("active");
        };
        const closeEditModal = () => modal.classList.remove("active");

        const saveDraftToLocalStorage = () => {
            const entriesToSave = Array.from(draftQuantities.entries()).filter(([id, qtd]) => qtd > 0);
            if (entriesToSave.length > 0) {
                localStorage.setItem(DRAFT_KEY, JSON.stringify(entriesToSave));
            } else {
                localStorage.removeItem(DRAFT_KEY); 
            }
        };

        const loadDraftFromLocalStorage = () => {
            const savedData = localStorage.getItem(DRAFT_KEY);
            if (savedData) {
                try {
                    draftQuantities = new Map(JSON.parse(savedData));
                } catch (e) {
                    console.error("Erro ao carregar rascunho:", e);
                    draftQuantities = new Map();
                    localStorage.removeItem(DRAFT_KEY);
                }
            } else {
                draftQuantities = new Map(); 
            }
        };

        const startNewCount = () => {
            document.getElementById("contagemResponsavel").value = currentUserProfile.nome;
            const setorSelect = document.getElementById("contagemSetor");
            const catFiltroSelect = document.getElementById("contagemFiltroCategoria");
            setorSelect.innerHTML = '<option value="">-- Selecione um setor --</option>';
            const setoresPermitidos = currentUserProfile.role === "admin" ? setoresCache : setoresCache.filter(s => currentUserProfile.setorIds.includes(s.id));
            setoresPermitidos.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(s => { setorSelect.innerHTML += `<option value="${s.id}">${s.nome}</option>`; });
            populateDropdown(catFiltroSelect, categoriasCache, "Filtrar por Categoria");
            catFiltroSelect.insertAdjacentHTML("afterbegin", '<option value="todos">Todas as Categorias</option>');
            catFiltroSelect.value = "todos";
            document.getElementById("contagemFiltroProduto").value = "";

            loadDraftFromLocalStorage();

            const tableBody = document.getElementById("tableContagem").querySelector("tbody");
            tableBody.innerHTML = "";
            
            produtosCache.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(prod => {
                const row = tableBody.insertRow();
                row.dataset.categoriaId = prod.categoria_id;

                const cellProduto = row.insertCell();
                cellProduto.textContent = prod.nome;

                const cellCodigo = row.insertCell();
                cellCodigo.textContent = prod.codigo;

                const cellQtd = row.insertCell();
                const qtdInput = document.createElement('input');
                qtdInput.type = 'number';
                qtdInput.min = '0';
                qtdInput.placeholder = '0';
                qtdInput.className = 'input-quantidade';
                qtdInput.dataset.produtoId = prod.id;

                const savedQtd = draftQuantities.get(prod.id);
                if (savedQtd) {
                    qtdInput.value = savedQtd;
                }

                qtdInput.addEventListener('input', () => {
                    const qtd = parseInt(qtdInput.value, 10) || 0;
                    if (qtd > 0) {
                        draftQuantities.set(prod.id, qtd);
                    } else {
                        draftQuantities.delete(prod.id); 
                    }
                    saveDraftToLocalStorage();
                });
                
                cellQtd.appendChild(qtdInput);
            });
            
            applyFilters(); 
        };

        const handleSaveCount = async () => {
            if (!currentUserProfile) return alert("Erro: Usu치rio n칚o identificado.");
            const setorId = document.getElementById("contagemSetor").value;
            if (!setorId) return alert("Por favor, selecione o setor.");
            const setor = setoresCache.find(s => s.id == setorId);

            if (draftQuantities.size === 0) {
                alert("Nenhum item foi contado. Adicione as quantidades.");
                return;
            }
            
            const itensContados = [];
            for (const [produtoId, quantidade] of draftQuantities.entries()) {
                const produto = produtosCache.find(p => p.id == produtoId);
                if (produto) {
                    itensContados.push({ 
                        id: produto.id, 
                        codigo: produto.codigo, 
                        nome: produto.nome, 
                        categoria_id: produto.categoria_id, 
                        quantidade: quantidade 
                    });
                }
            }

            const novaContagem = { responsavel_id: currentUserProfile.id, responsavel_nome: currentUserProfile.nome, setor_id: setorId, setor_nome: setor.nome, itens: itensContados };
            
            showLoader();
            try {
                const { data, error } = await _supabaseClient.from("contagens").insert(novaContagem).select().single();
                if (error) throw error;
                
                alert("Contagem salva com sucesso!");
                
                draftQuantities.clear();
                localStorage.removeItem(DRAFT_KEY);
                
                await showCountDetails(data.id);
            } catch (error) { 
                alert(`Erro ao salvar contagem: ${error.message}`); 
            } finally { 
                hideLoader(); 
            }
        };

        const showCountDetails = async (contagemId) => {
            showLoader();
            try {
                const { data: contagem, error } = await _supabaseClient.from("contagens").select("*").eq("id", contagemId).single();
                if (error) throw error;
                if (!contagem) { alert("Contagem n칚o encontrada!"); showScreen("screenDashboard"); return; }
                document.getElementById("visualizarContagemDetalhes").innerHTML = `<p><strong>Respons치vel:</strong> ${contagem.responsavel_nome}</p><p><strong>Setor:</strong> ${contagem.setor_nome}</p><p><strong>Data e Hora:</strong> ${new Date(contagem.created_at).toLocaleString("pt-BR")}</p><hr><p><strong>Total de Tipos de Itens Contados:</strong> ${contagem.itens.length}</p>`;
                const tableBody = document.getElementById("tableContagemFinalizada").querySelector("tbody");
                tableBody.innerHTML = "";
                contagem.itens.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(item => {
                    const categoria = categoriasCache.find(c => c.id == item.categoria_id);
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${item.nome}</td>
                        <td>${item.codigo}</td>
                        <td>${categoria ? categoria.nome : "N/A"}</td>
                        <td>${item.quantidade}</td>`;
                });
                showScreen("screenVisualizarContagem");
            } catch (error) { alert(`Erro ao carregar detalhes: ${error.message}`); } finally { hideLoader(); }
        };

        const handleExportTXT = async (contagemId) => {
            const { data: contagem, error } = await _supabaseClient.from("contagens").select("itens, created_at, setor_nome").eq("id", contagemId).single();
            if (error || !contagem) return alert("Contagem n칚o encontrada para exportar.");
            const fileContent = contagem.itens.map(item => `${item.codigo};${item.quantidade}`).join("\n");
            const date = new Date(contagem.created_at);
            const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
            const setorString = contagem.setor_nome.replace(/[^a-zA-Z0-9]/g, "_");
            const fileName = `Contagem_${dateString}_Setor_${setorString}.txt`;
            const blob = new Blob([fileContent], { type: "text/plain;charset=utf-8" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const applyFilters = () => {
            const catId = document.getElementById("contagemFiltroCategoria").value;
            const searchTerm = document.getElementById("contagemFiltroProduto").value.trim().toLowerCase();
            const rows = document.getElementById("tableContagem").querySelectorAll("tbody tr");

            rows.forEach(row => {
                const rowCatId = row.dataset.categoriaId;
                const productNameCell = row.cells[0]; 
                if (!productNameCell) return; 
                const productName = productNameCell.textContent.toLowerCase();
                const categoryMatch = (catId === "todos" || rowCatId === catId);
                const productMatch = productName.includes(searchTerm);
                if (categoryMatch && productMatch) {
                    row.style.display = ""; 
                } else {
                    row.style.display = "none";
                }
            });
        };

        // --- 游 NOVA FUN칂츾O 游 ---
        // Filtro para a tela de Gerenciar Produtos
        const applyProdutoFilters = () => {
            const searchTerm = document.getElementById('filtroProdutoNome').value.trim().toLowerCase();
            const catId = document.getElementById('filtroProdutoCategoria').value;
            const rows = document.getElementById('tableProdutos').querySelectorAll("tbody tr");

            rows.forEach(row => {
                const productNameCell = row.cells[1];
                const rowCatId = row.dataset.categoriaId;
                
                if (!productNameCell) return;

                const productName = productNameCell.textContent.toLowerCase();
                
                const categoryMatch = (catId === "todos" || rowCatId === catId);
                const productMatch = productName.includes(searchTerm);

                row.style.display = (categoryMatch && productMatch) ? "" : "table-row"; // 'table-row' 칠 o display padr칚o
            });
        };

        // --- INICIALIZA칂츾O E EVENT LISTENERS ---
        const { data: { session } } = await _supabaseClient.auth.getSession();
        if (session) {
            await initializeApp(session.user);
        } else {
            hideLoader();
            showScreen('screenLogin');
        }

        document.getElementById('loginButton').addEventListener('click', handleLogin);
        document.getElementById('btnLogout').addEventListener('click', handleLogout);
        document.querySelectorAll('.btn-back').forEach(button => button.addEventListener('click', () => showScreen(button.dataset.target)));
        
        // --- 游 ATUALIZADO 游 ---
        // Adiciona a l칩gica de popular os filtros ao navegar
        document.getElementById('btnNavProdutos').addEventListener('click', () => { 
            renderProdutoTable(); 
            populateCategoriaDropdown(document.getElementById('produtoCategoria')); 
            populateSetorDropdown(document.getElementById('produtoSetor'));
            
            // Popula os novos filtros
            const catFiltroSelect = document.getElementById('filtroProdutoCategoria');
            populateCategoriaDropdown(catFiltroSelect);
            catFiltroSelect.insertAdjacentHTML("afterbegin", '<option value="todos" selected>Todas as Categorias</option>');
            document.getElementById('filtroProdutoNome').value = ""; 

            showScreen('screenProdutos'); 
        });
        
        document.getElementById('btnNavCategorias').addEventListener('click', () => { renderSimpleTable('categorias', categoriasCache, document.getElementById('tableCategorias').querySelector('tbody')); showScreen('screenCategorias'); });
        document.getElementById('btnNavSetores').addEventListener('click', () => { renderSimpleTable('setores', setoresCache, document.getElementById('tableSetores').querySelector('tbody')); showScreen('screenSetores'); });
        document.getElementById('btnNavUsuarios').addEventListener('click', async () => { await loadUsersCache(); renderUsuarioTable(); populateSetorCheckboxes(document.getElementById('usuarioSetores')); showScreen('screenUsuarios'); });
        document.getElementById('btnNavNovaContagem').addEventListener('click', () => { startNewCount(); showScreen('screenNovaContagem'); });
        document.getElementById('btnNavHistorico').addEventListener('click', async () => { await renderHistoricoTable(); showScreen('screenHistorico'); });
        
        setupSimpleForm('formAddCategoria', 'categoriaNome', 'categorias', document.getElementById('tableCategorias').querySelector('tbody'));
        setupSimpleForm('formAddSetor', 'setorNome', 'setores', document.getElementById('tableSetores').querySelector('tbody'));
        document.getElementById("btnSalvarContagem").addEventListener("click", handleSaveCount);
        document.getElementById("btnCancelEdit").addEventListener("click", closeEditModal);

        // Filtros da Tela de Contagem
        document.getElementById("contagemFiltroProduto").addEventListener("input", applyFilters);
        document.getElementById("contagemFiltroCategoria").addEventListener("change", applyFilters);
        
        // --- 游 NOVOS LISTENERS 游 ---
        // Filtros da Tela de Gerenciar Produtos
        document.getElementById("filtroProdutoNome").addEventListener("input", applyProdutoFilters);
        document.getElementById("filtroProdutoCategoria").addEventListener("change", applyProdutoFilters);
        
        // Login com Enter
        document.getElementById('loginEmailContador').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); 
                handleLogin();
            }
        });
        document.getElementById('loginPasswordAdmin').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleLogin();
            }
        });
        
    });
    </script>
</body>
</html>
