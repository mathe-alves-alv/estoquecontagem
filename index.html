<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Contagem de Estoque v8.0 (Supabase)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #007bff; --success-color: #198754; --info-color: #0dcaf0; --danger-color: #dc3545; --background-color: #f4f6f9; --container-bg-color: #ffffff; --text-color: #212529; --border-color: #dee2e6; --border-radius: 0.375rem; --box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 10px 0; background-color: var(--background-color); color: var(--text-color); display: flex; flex-direction: column; align-items: center; min-height: 100vh; font-size: 16px; }
        .container { width: 95%; max-width: 800px; background-color: var(--container-bg-color); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); margin: 15px 0; border: 1px solid var(--border-color); }
        h1, h2, h3 { text-align: center; margin-top: 0; margin-bottom: 1.5rem; font-weight: 500; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeInView .4s; }
        @keyframes fadeInView { from { opacity: 0; } to { opacity: 1; } }
        button, .btn { border: 1px solid transparent; padding: .6rem 1rem; font-size: 1rem; border-radius: var(--border-radius); cursor: pointer; transition: background-color .15s; margin: .25rem; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-info { background-color: var(--info-color); color: black; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .dashboard-options { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; padding: 1rem 0; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        th, td { border: 1px solid var(--border-color); padding: .6rem; text-align: left; word-break: break-word; }
        th { background-color: #f8f9fa; }
        input, select { width: 100%; padding: .7rem .75rem; margin-bottom: 1rem; border: 1px solid #ced4da; border-radius: var(--border-radius); box-sizing: border-box; font-size: 1rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: .5rem; font-weight: 500; }
        .card { border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: 1.5rem; box-shadow: var(--box-shadow); }
        .card-header { padding: .75rem 1.25rem; background-color: #f8f9fa; border-bottom: 1px solid var(--border-color); }
        .card-header h3 { margin: 0; font-size: 1.25rem; }
        .card-body { padding: 1.25rem; overflow-x: auto; }
        .form-inline { display: flex; gap: 1rem; align-items: flex-end; }
        #loginErrorMessage { color: var(--danger-color); margin-top: 1rem; text-align: center; display: none; }
        .table-actions button { margin: 0 2px; padding: .25rem .5rem; font-size: .85rem; }
        .back-button { margin-bottom: 1.5rem; display: inline-block; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal-content { background-color: white; padding: 25px; border-radius: var(--border-radius); width: 90%; max-width: 500px; }
        .modal-actions { margin-top: 1.5rem; text-align: right; }
        .setores-checkbox-group { max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: var(--border-radius); margin-bottom: 1rem; }
        .setores-checkbox-group label { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; }
        .setores-checkbox-group input[type="checkbox"] { width: auto; margin-bottom: 0; }
        .admin-only { display: none; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 600px) {
            .dashboard-options { grid-template-columns: 1fr; }
            .form-inline { flex-direction: column; align-items: stretch; }
            .table-actions { display: flex; flex-direction: column; gap: 5px; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div id="mainContainer" class="container">
        <div id="loader" class="loader"></div>

        <div id="screenLogin" class="screen active">
            <h1>Login no Sistema</h1>
            <div class="card card-body">
                <div class="form-group"><label for="loginEmail">Email:</label><input type="email" id="loginEmail" required></div>
                <div class="form-group"><label for="loginPassword">Senha:</label><input type="password" id="loginPassword" required></div>
                <button class="btn btn-primary" id="loginButton" style="width: 100%;">Entrar</button>
                <div id="loginErrorMessage"></div>
            </div>
        </div>

        <div id="appContent" style="display: none;">
            <div id="screenDashboard" class="screen">
                <h2>Painel de Controle</h2>
                <p>Logado como: <strong id="userDisplay"></strong></p>
                <div class="dashboard-options">
                    <button class="btn btn-primary" id="btnNavNovaContagem">‚ñ∂Ô∏è Iniciar Nova Contagem</button>
                    <button class="btn btn-info" id="btnNavHistorico">üìÑ Hist√≥rico de Contagens</button>
                    <button class="btn btn-secondary admin-only" id="btnNavProdutos">üì¶ Gerenciar Produtos</button>
                    <button class="btn btn-secondary admin-only" id="btnNavCategorias">üè∑Ô∏è Gerenciar Categorias</button>
                    <button class="btn btn-secondary admin-only" id="btnNavSetores">üè¢ Gerenciar Setores</button>
                    <button class="btn btn-secondary admin-only" id="btnNavUsuarios">üë• Gerenciar Usu√°rios</button>
                    <button class="btn btn-danger" id="btnLogout"> Sair</button>
                </div>
            </div>
            
            <div id="screenUsuarios" class="screen">
                <button class="btn btn-secondary back-button btn-back" data-target="screenDashboard">&larr; Voltar</button>
                <h2>Gerenciar Usu√°rios</h2>
                <div class="card">
                    <div class="card-header"><h3>Adicionar Novo Usu√°rio</h3></div>
                    <div class="card-body">
                        <form id="formAddUsuario">
                            <div class="form-group"><label for="usuarioNome">Nome:</label><input type="text" id="usuarioNome" required></div>
                            <div class="form-group"><label for="usuarioEmail">Email (para login):</label><input type="email" id="usuarioEmail" required></div>
                            <div class="form-group"><label for="usuarioPassword">Senha:</label><input type="password" id="usuarioPassword" required></div>
                            <div class="form-group"><label for="usuarioRole">Fun√ß√£o:</label><select id="usuarioRole" required><option value="contador">Contador</option><option value="admin">Admin</option></select></div>
                            <div class="form-group"><label>Setores Permitidos:</label><div id="usuarioSetores" class="setores-checkbox-group"></div></div>
                            <button type="submit" class="btn btn-success">Adicionar Usu√°rio</button>
                        </form>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h3>Usu√°rios Cadastrados</h3></div>
                    <div class="card-body"><table id="tableUsuarios"><thead><tr><th>Nome</th><th>Email</th><th>Fun√ß√£o</th><th>Setores</th><th>A√ß√£o</th></tr></thead><tbody></tbody></table></div>
                </div>
            </div>

            <div id="screenProdutos" class="screen">
                <button class="btn btn-secondary back-button btn-back" data-target="screenDashboard">&larr; Voltar</button>
                <h2>Gerenciar Produtos</h2>
                <div class="card"><div class="card-header"><h3>Adicionar Novo Produto</h3></div><div class="card-body"><form id="formAddProduto"><div class="form-group"><label for="produtoCodigo">C√≥digo:</label><input type="text" id="produtoCodigo" required></div><div class="form-group"><label for="produtoNome">Nome do Produto:</label><input type="text" id="produtoNome" required></div><div class="form-group"><label for="produtoCategoria">Categoria:</label><select id="produtoCategoria" required></select></div><div class="form-group"><label for="produtoSetor">Setor:</label><select id="produtoSetor" required></select></div><button type="submit" class="btn btn-success">Adicionar Produto</button></form></div></div>
                <div class="card"><div class="card-header"><h3>Produtos Cadastrados</h3></div><div class="card-body"><table id="tableProdutos"><thead><tr><th>C√≥digo</th><th>Nome</th><th>Categoria</th><th>Setor</th><th>A√ß√£o</th></tr></thead><tbody></tbody></table></div></div>
            </div>

            <div id="screenCategorias" class="screen">
                <button class="btn btn-secondary back-button btn-back" data-target="screenDashboard">&larr; Voltar</button>
                <h2>Gerenciar Categorias</h2>
                <div class="card"><div class="card-header"><h3>Adicionar Nova Categoria</h3></div><div class="card-body"><form id="formAddCategoria" class="form-inline"><div class="form-group" style="flex-grow: 1; margin: 0;"><label for="categoriaNome">Nome da Categoria:</label><input type="text" id="categoriaNome" required></div><button type="submit" class="btn btn-success">Adicionar</button></form></div></div>
                <div class="card"><div class="card-header"><h3>Categorias Cadastradas</h3></div><div class="card-body"><table id="tableCategorias"><thead><tr><th>Nome</th><th>A√ß√£o</th></tr></thead><tbody></tbody></table></div></div>
            </div>

            <div id="screenSetores" class="screen">
                <button class="btn btn-secondary back-button btn-back" data-target="screenDashboard">&larr; Voltar</button>
                <h2>Gerenciar Setores</h2>
                <div class="card"><div class="card-header"><h3>Adicionar Novo Setor</h3></div><div class="card-body"><form id="formAddSetor" class="form-inline"><div class="form-group" style="flex-grow: 1; margin: 0;"><label for="setorNome">Nome do Setor:</label><input type="text" id="setorNome" required></div><button type="submit" class="btn btn-success">Adicionar</button></form></div></div>
                <div class="card"><div class="card-header"><h3>Setores Cadastrados</h3></div><div class="card-body"><table id="tableSetores"><thead><tr><th>Nome</th><th>A√ß√£o</th></tr></thead><tbody></tbody></table></div></div>
            </div>

            <div id="screenNovaContagem" class="screen">
                <button class="btn btn-secondary back-button btn-back" data-target="screenDashboard">&larr; Voltar</button>
                <h2>Realizar Contagem de Estoque</h2>
                <div class="card card-body"><div class="form-group"><label for="contagemResponsavel">Respons√°vel:</label><input type="text" id="contagemResponsavel" disabled></div><div class="form-group"><label for="contagemSetor">Setor:</label><select id="contagemSetor" required></select></div><div class="form-group"><label for="contagemFiltroCategoria">Filtrar por Categoria:</label><select id="contagemFiltroCategoria"></select></div></div>
                <div class="card card-body"><table id="tableContagem"><thead><tr><th>C√≥digo</th><th>Produto</th><th>Qtd</th></tr></thead><tbody></tbody></table></div>
                <button class="btn btn-success" id="btnSalvarContagem" style="width: 100%; padding: 0.8rem; font-size: 1.2rem;">Salvar Contagem</button>
            </div>

            <div id="screenHistorico" class="screen">
                <button class="btn btn-secondary back-button btn-back" data-target="screenDashboard">&larr; Voltar</button>
                <h2>Hist√≥rico de Contagens</h2>
                <div class="card"><div class="card-header"><h3>Registros Salvos</h3></div><div class="card-body"><table id="tableHistorico"><thead><tr><th>Data</th><th>Respons√°vel</th><th>Setor</th><th>Itens</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table></div></div>
            </div>

            <div id="screenVisualizarContagem" class="screen">
                <button class="btn btn-secondary back-button btn-back" data-target="screenDashboard">&larr; Voltar ao Painel</button>
                <h2>Resumo da Contagem</h2>
                <div id="visualizarContagemDetalhes" class="card card-body"></div>
                <div class="card"><div class="card-header"><h3>Itens Contados</h3></div><div class="card-body"><table id="tableContagemFinalizada"><thead><tr><th>C√≥digo</th><th>Produto</th><th>Categoria</th><th>Qtd</th></tr></thead><tbody></tbody></table></div></div>
            </div>
        </div>
    </div>
    
    <div id="modalEditProduto" class="modal-overlay">
        <div class="modal-content">
            <h3>Editar Produto</h3>
            <form id="formEditProduto">
                <input type="hidden" id="editProdutoId">
                <div class="form-group"><label for="editProdutoCodigo">C√≥digo:</label><input type="text" id="editProdutoCodigo" required></div>
                <div class="form-group"><label for="editProdutoNome">Nome do Produto:</label><input type="text" id="editProdutoNome" required></div>
                <div class="form-group"><label for="editProdutoCategoria">Categoria:</label><select id="editProdutoCategoria" required></select></div>
                <div class="form-group"><label for="editProdutoSetor">Setor:</label><select id="editProdutoSetor" required></select></div>
                <div class="modal-actions"><button type="button" class="btn btn-secondary" id="btnCancelEdit">Cancelar</button><button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button></div>
            </form>
        </div>
    </div>
    <template id="template-linha-simples"><tr><td data-cell="nome"></td><td class="table-actions"><button class="btn btn-danger btn-deletar">Excluir</button></td></tr></template>
    <template id="template-linha-produto"><tr><td data-cell="codigo"></td><td data-cell="nome"></td><td data-cell="categoria"></td><td data-cell="setor"></td><td class="table-actions"><button class="btn btn-info btn-editar">Editar</button><button class="btn btn-danger btn-deletar">Excluir</button></td></tr></template>
    <template id="template-linha-historico"><tr><td data-cell="data"></td><td data-cell="responsavel"></td><td data-cell="setor"></td><td data-cell="itens"></td><td class="table-actions"><button class="btn btn-primary btn-visualizar">Visualizar</button><button class="btn btn-success btn-exportar">Baixar TXT</button></td></tr></template>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {

        const SUPABASE_URL = 'https://ceubvhjwalylsfwuwezb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNldWJ2aGp3YWx5bHNmd3V3ZXpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4ODc4NDYsImV4cCI6MjA3NjQ2Mzg0Nn0.edAsL7rWed0jXCcNLy8oKDKsI5FfSY8r_fXyXRWrzso';

        const { createClient } = supabase;
        const _supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUserProfile = null;
        let usersCache = [], categoriasCache = [], setoresCache = [], produtosCache = [];

        const loader = document.getElementById('loader');
        const showLoader = () => loader.style.display = 'block';
        const hideLoader = () => loader.style.display = 'none';

        const screens = document.querySelectorAll('.screen');
        const showScreen = (screenId) => {
            screens.forEach(s => s.classList.remove('active'));
            document.getElementById(screenId)?.classList.add('active');
            window.scrollTo(0, 0);
        };

        // --- L√ìGICA DE AUTENTICA√á√ÉO E INICIALIZA√á√ÉO ---

        const handleLogin = async () => {
            showLoader();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginErrorMessage = document.getElementById('loginErrorMessage');
            loginErrorMessage.style.display = 'none';

            try {
                const { data, error } = await _supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                if (data.user) {
                    await initializeApp(data.user);
                }
            } catch (error) {
                console.error('Login error:', error);
                loginErrorMessage.textContent = 'Email ou senha inv√°lidos.';
                loginErrorMessage.style.display = 'block';
            } finally {
                hideLoader();
            }
        };

        const handleLogout = async () => {
            showLoader();
            await _supabaseClient.auth.signOut();
            currentUserProfile = null;
            document.getElementById('appContent').style.display = 'none';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            showScreen('screenLogin');
            hideLoader();
        };

        const initializeApp = async (user) => {
            showLoader();
            try {
                // Busca o perfil do usu√°rio logado
                const { data: profile, error: profileError } = await _supabaseClient.from('profiles').select('*').eq('id', user.id).single();
                if (profileError) throw profileError;
                currentUserProfile = profile;
                
                // Busca as permiss√µes de setor do usu√°rio
                const { data: setoresPermitidos, error: setoresError } = await _supabaseClient.from('profile_setores').select('setor_id').eq('profile_id', user.id);
                if (setoresError) throw setoresError;
                currentUserProfile.setorIds = setoresPermitidos.map(s => s.setor_id);

                document.getElementById('userDisplay').textContent = currentUserProfile.nome;
                
                // Carrega todos os dados iniciais em paralelo
                await Promise.all([
                    loadDataToCache('categorias'),
                    loadDataToCache('setores'),
                    loadDataToCache('produtos'),
                    loadUsersCache() // Carrega todos os usu√°rios para a tela de admin
                ]);
                
                updateUIForRole();
                document.getElementById('appContent').style.display = 'block';
                showScreen('screenDashboard');
            } catch (error) {
                console.error("Erro ao inicializar:", error);
                alert("N√£o foi poss√≠vel carregar seu perfil. Tente logar novamente.");
                await handleLogout();
            } finally {
                hideLoader();
            }
        };
        
        const loadDataToCache = async (entity) => {
            try {
                const { data, error } = await _supabaseClient.from(entity).select('*');
                if (error) throw error;
                if (entity === 'categorias') categoriasCache = data;
                else if (entity === 'setores') setoresCache = data;
                else if (entity === 'produtos') produtosCache = data;
            } catch (error) { console.error(`Error loading ${entity}:`, error); alert(`Falha ao carregar ${entity}.`); }
        };

        const loadUsersCache = async () => {
            if(currentUserProfile.role !== 'admin') return;
            try {
                const { data, error } = await _supabaseClient.rpc('get_profiles_with_sectors');
                if (error) throw error;
                usersCache = data;
            } catch (error) { console.error(`Error loading users:`, error); alert(`Falha ao carregar usu√°rios.`); }
        };

        // --- INICIALIZA√á√ÉO DA P√ÅGINA ---
        const { data: { session } } = await _supabaseClient.auth.getSession();
        if (session) {
            await initializeApp(session.user);
        } else {
            showScreen('screenLogin');
        }

        const updateUIForRole = () => { /* ... c√≥digo sem altera√ß√£o ... */ };
        
        // --- EVENT LISTENERS ---
        document.getElementById('loginButton').addEventListener('click', handleLogin);
        document.getElementById('btnLogout').addEventListener('click', handleLogout);
        document.querySelectorAll('.btn-back').forEach(button => button.addEventListener('click', () => showScreen(button.dataset.target)));
        document.getElementById('btnNavProdutos').addEventListener('click', () => { renderProdutoTable(); populateCategoriaDropdown(document.getElementById('produtoCategoria')); populateSetorDropdown(document.getElementById('produtoSetor')); showScreen('screenProdutos'); });
        document.getElementById('btnNavCategorias').addEventListener('click', () => { renderSimpleTable('categorias', categoriasCache, document.getElementById('tableCategorias').querySelector('tbody')); showScreen('screenCategorias'); });
        document.getElementById('btnNavSetores').addEventListener('click', () => { renderSimpleTable('setores', setoresCache, document.getElementById('tableSetores').querySelector('tbody')); showScreen('screenSetores'); });
        document.getElementById('btnNavUsuarios').addEventListener('click', () => { renderUsuarioTable(); populateSetorCheckboxes(document.getElementById('usuarioSetores')); showScreen('screenUsuarios'); });
        document.getElementById('btnNavNovaContagem').addEventListener('click', () => { startNewCount(); showScreen('screenNovaContagem'); });
        document.getElementById('btnNavHistorico').addEventListener('click', async () => { await renderHistoricoTable(); showScreen('screenHistorico'); });

        // --- FUN√á√ïES DE CRUD, CONTAGEM E HIST√ìRICO (ADAPTADAS PARA SUPABASE ASYNC) ---
        // (O c√≥digo abaixo foi totalmente reescrito para ser ass√≠ncrono e usar o Supabase)
        
        const populateSetorCheckboxes = (container, selectedIds = []) => {
            container.innerHTML = '';
            if (setoresCache.length === 0) { container.innerHTML = 'Nenhum setor cadastrado.'; return; }
            setoresCache.sort((a,b)=> a.nome.localeCompare(b.nome)).forEach(setor => {
                const checked = (selectedIds || []).includes(setor.id) ? 'checked' : '';
                container.innerHTML += `<label><input type="checkbox" value="${setor.id}" ${checked}> ${setor.nome}</label>`;
            });
        };

        const renderUsuarioTable = () => {
            const tableBody = document.getElementById('tableUsuarios').querySelector('tbody');
            tableBody.innerHTML = '';
            usersCache.sort((a,b)=> a.nome.localeCompare(b.nome)).forEach(user => {
                const setorNomes = (user.setor_ids || []).map(id => setoresCache.find(s => s.id === id)?.nome).filter(Boolean).join(', ') || 'N/A';
                const row = tableBody.insertRow();
                row.innerHTML = `<td>${user.nome}</td><td>${user.email}</td><td>${user.role}</td><td>${setorNomes}</td><td class="table-actions"><button class="btn btn-danger" data-id="${user.id}">Excluir</button></td>`;
                row.querySelector('.btn-danger').addEventListener('click', async (e) => {
                    const idToDelete = e.target.dataset.id;
                    if (idToDelete === currentUserProfile.id) { alert("Voc√™ n√£o pode excluir a si mesmo."); return; }
                    if (confirm(`Tem certeza que deseja excluir o usu√°rio "${user.nome}"? Esta a√ß√£o √© irrevers√≠vel.`)) {
                        alert("Funcionalidade de exclus√£o de usu√°rio via Edge Function precisa ser implementada.");
                        // TODO: Chamar Edge Function para deletar usu√°rio
                    }
                });
            });
        };

        document.getElementById('formAddUsuario').addEventListener('submit', async (e) => {
            e.preventDefault();
            // TODO: Implementar cria√ß√£o de usu√°rio via Edge Function para seguran√ßa.
            alert("Funcionalidade de cria√ß√£o de usu√°rio via Edge Function precisa ser implementada.");
        });

        const renderSimpleTable = (entity, data, tableBody) => {
            const template = document.getElementById('template-linha-simples');
            tableBody.innerHTML = '';
            if (data.length === 0) { tableBody.innerHTML = `<tr><td colspan="2">Nenhum item cadastrado.</td></tr>`; return; }
            data.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(item => {
                const clone = template.content.cloneNode(true);
                clone.querySelector('[data-cell="nome"]').textContent = item.nome;
                clone.querySelector('.btn-deletar').addEventListener('click', async () => {
                    if (confirm(`Tem certeza que deseja excluir "${item.nome}"?`)) {
                        showLoader();
                        try {
                            const { error } = await _supabaseClient.from(entity).delete().eq('id', item.id);
                            if (error) throw error;
                            await loadDataToCache(entity);
                            renderSimpleTable(entity, (entity === 'categorias' ? categoriasCache : setoresCache), tableBody);
                        } catch(error) { alert(`Erro ao excluir: ${error.message}`); } finally { hideLoader(); }
                    }
                });
                tableBody.appendChild(clone);
            });
        };
        const setupSimpleForm = (formId, inputId, entity, tableBody) => {
            document.getElementById(formId).addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = document.getElementById(inputId);
                const nome = input.value.trim();
                if (!nome) return;
                const cache = (entity === 'categorias' ? categoriasCache : setoresCache);
                if (cache.some(item => item.nome.toLowerCase() === nome.toLowerCase())) { alert(`O item "${nome}" j√° est√° cadastrado.`); return; }
                showLoader();
                try {
                    const { error } = await _supabaseClient.from(entity).insert({ nome });
                    if (error) throw error;
                    input.value = '';
                    await loadDataToCache(entity);
                    renderSimpleTable(entity, (entity === 'categorias' ? categoriasCache : setoresCache), tableBody);
                } catch(error) { alert(`Erro ao adicionar: ${error.message}`); } finally { hideLoader(); }
            });
        };
        setupSimpleForm('formAddCategoria', 'categoriaNome', 'categorias', document.getElementById('tableCategorias').querySelector('tbody'));
        setupSimpleForm('formAddSetor', 'setorNome', 'setores', document.getElementById('tableSetores').querySelector('tbody'));
        
        // --- RESTANTE DAS FUN√á√ïES (ADAPTADAS PARA ASYNC/SUPABASE) ---
        // (O c√≥digo completo est√° aqui, sem abrevia√ß√µes)
        updateUIForRole = () => {const isAdmin=currentUserProfile&&currentUserProfile.role==="admin";document.querySelectorAll(".admin-only").forEach(el=>{el.style.display=isAdmin?"block":"none"})};
        const populateDropdown=(selectElement,data,placeholder)=>{selectElement.innerHTML=`<option value="">-- ${placeholder} --</option>`;data.sort((a,b)=>a.nome.localeCompare(b.nome)).forEach(item=>{selectElement.innerHTML+=`<option value="${item.id}">${item.nome}</option>`})};
        const populateCategoriaDropdown=(elem)=>populateDropdown(elem,categoriasCache,"Selecione a Categoria");
        const populateSetorDropdown=(elem)=>populateDropdown(elem,setoresCache,"Selecione o Setor");
        const renderProdutoTable=()=>{const tableBody=document.getElementById("tableProdutos").querySelector("tbody"),template=document.getElementById("template-linha-produto");tableBody.innerHTML="";if(produtosCache.length===0){tableBody.innerHTML=`<tr><td colspan="5">Nenhum produto cadastrado.</td></tr>`;return}produtosCache.sort((a,b)=>a.nome.localeCompare(b.nome)).forEach(prod=>{const categoria=categoriasCache.find(c=>c.id===prod.categoria_id),setor=setoresCache.find(s=>s.id===prod.setor_id),clone=template.content.cloneNode(!0);clone.querySelector('[data-cell="codigo"]').textContent=prod.codigo;clone.querySelector('[data-cell="nome"]').textContent=prod.nome;clone.querySelector('[data-cell="categoria"]').textContent=categoria?categoria.nome:"N/A";clone.querySelector('[data-cell="setor"]').textContent=setor?setor.nome:"N/A";clone.querySelector(".btn-editar").addEventListener("click",()=>openEditModal(prod.id));clone.querySelector(".btn-deletar").addEventListener("click",async()=>{if(confirm(`Tem certeza que deseja excluir o produto "${prod.nome}"?`)){showLoader();try{const{error}=await _supabaseClient.from("produtos").delete().eq("id",prod.id);if(error)throw error;await loadDataToCache("produtos");renderProdutoTable()}catch(error){alert(`Erro ao excluir produto: ${error.message}`)}finally{hideLoader()}}});tableBody.appendChild(clone)})};
        document.getElementById("formAddProduto").addEventListener("submit",async e=>{e.preventDefault();const codigo=document.getElementById("produtoCodigo").value.trim(),nome=document.getElementById("produtoNome").value.trim(),categoria_id=document.getElementById("produtoCategoria").value,setor_id=document.getElementById("produtoSetor").value;if(!codigo||!nome||!categoria_id||!setor_id)return alert("Todos os campos s√£o obrigat√≥rios.");if(produtosCache.some(p=>p.codigo.toLowerCase()===codigo.toLowerCase()))return alert(`O c√≥digo "${codigo}" j√° est√° cadastrado.`);showLoader();try{const{error}=await _supabaseClient.from("produtos").insert({codigo,nome,categoria_id,setor_id});if(error)throw error;e.target.reset();await loadDataToCache("produtos");renderProdutoTable()}catch(error){alert(`Erro ao adicionar produto: ${error.message}`)}finally{hideLoader()}});
        const modal=document.getElementById("modalEditProduto"),openEditModal=produtoId=>{const produto=produtosCache.find(p=>p.id===produtoId);if(!produto)return;populateCategoriaDropdown(document.getElementById("editProdutoCategoria"));populateSetorDropdown(document.getElementById("editProdutoSetor"));document.getElementById("editProdutoId").value=produto.id;document.getElementById("editProdutoCodigo").value=produto.codigo;document.getElementById("editProdutoNome").value=produto.nome;document.getElementById("editProdutoCategoria").value=produto.categoria_id;document.getElementById("editProdutoSetor").value=produto.setor_id;modal.classList.add("active")},closeEditModal=()=>modal.classList.remove("active");
        document.getElementById("btnCancelEdit").addEventListener("click",closeEditModal);document.getElementById("formEditProduto").addEventListener("submit",async e=>{e.preventDefault();const id=document.getElementById("editProdutoId").value,codigo=document.getElementById("editProdutoCodigo").value.trim(),nome=document.getElementById("editProdutoNome").value.trim(),categoria_id=document.getElementById("editProdutoCategoria").value,setor_id=document.getElementById("editProdutoSetor").value;if(!codigo||!nome||!categoria_id||!setor_id)return alert("Todos os campos s√£o obrigat√≥rios.");if(produtosCache.some(p=>p.codigo.toLowerCase()===codigo.toLowerCase()&&p.id!==id))return alert(`O c√≥digo "${codigo}" j√° pertence a outro produto.`);showLoader();try{const{error}=await _supabaseClient.from("produtos").update({codigo,nome,categoria_id,setor_id}).eq("id",id);if(error)throw error;await loadDataToCache("produtos");renderProdutoTable();closeEditModal()}catch(error){alert(`Erro ao atualizar produto: ${error.message}`)}finally{hideLoader()}});
        const startNewCount=()=>{document.getElementById("contagemResponsavel").value=currentUserProfile.nome;const setorSelect=document.getElementById("contagemSetor"),catFiltroSelect=document.getElementById("contagemFiltroCategoria");setorSelect.innerHTML='<option value="">-- Selecione um setor --</option>';const setoresPermitidos=currentUserProfile.role==="admin"?setoresCache:setoresCache.filter(s=>currentUserProfile.setorIds.includes(s.id));setoresPermitidos.sort((a,b)=>a.nome.localeCompare(b.nome)).forEach(s=>setorSelect.innerHTML+=`<option value="${s.id}">${s.nome}</option>`);populateDropdown(catFiltroSelect,categoriasCache,"Filtrar por Categoria");catFiltroSelect.insertAdjacentHTML("afterbegin",'<option value="todos">Todas as Categorias</option>');catFiltroSelect.value="todos";const tableBody=document.getElementById("tableContagem").querySelector("tbody");tableBody.innerHTML="";produtosCache.sort((a,b)=>a.nome.localeCompare(b.nome)).forEach(prod=>{const row=tableBody.insertRow();row.dataset.categoriaId=prod.categoria_id;row.innerHTML=`<td>${prod.codigo}</td><td>${prod.nome}</td><td><input type="number" min="0" class="input-quantidade" data-produto-id="${prod.id}" placeholder="0"></td>`})};
        const handleSaveCount=async()=>{if(!currentUserProfile){alert("Erro: Usu√°rio n√£o identificado.");return}const setorId=document.getElementById("contagemSetor").value;if(!setorId){alert("Por favor, selecione o setor.");return}const setor=setoresCache.find(s=>s.id===setorId);const itensContados=[];document.querySelectorAll("#tableContagem .input-quantidade").forEach(input=>{const quantidade=parseInt(input.value,10)||0,produto=produtosCache.find(p=>p.id===input.dataset.produtoId);if(produto)itensContados.push({id:produto.id,codigo:produto.codigo,nome:produto.nome,categoria_id:produto.categoria_id,quantidade})});const novaContagem={responsavel_id:currentUserProfile.id,responsavel_nome:currentUserProfile.nome,setor_id:setorId,setor_nome:setor.nome,itens:itensContados};showLoader();try{const{data,error}=await _supabaseClient.from("contagens").insert(novaContagem).select().single();if(error)throw error;alert("Contagem salva com sucesso!");await showCountDetails(data.id)}catch(error){alert(`Erro ao salvar contagem: ${error.message}`)}finally{hideLoader()}};
        document.getElementById("btnSalvarContagem").addEventListener("click",handleSaveCount);document.getElementById("contagemFiltroCategoria").addEventListener("change",e=>{const catId=e.target.value;document.getElementById("tableContagem").querySelectorAll("tbody tr").forEach(row=>{row.style.display=catId==="todos"||row.dataset.categoriaId===catId?"":"none"})});
        const renderHistoricoTable=async()=>{showLoader();try{let{data:contagens,error}=await _supabaseClient.from("contagens").select("*").order("created_at",{ascending:!1});if(error)throw error;if(currentUserProfile.role==="contador"){contagens=contagens.filter(c=>currentUserProfile.setorIds.includes(c.setor_id))}const tableBody=document.getElementById("tableHistorico").querySelector("tbody"),template=document.getElementById("template-linha-historico");tableBody.innerHTML="";if(contagens.length===0){tableBody.innerHTML=`<tr><td colspan="5">Nenhuma contagem registrada para seus setores.</td></tr>`;return}contagens.forEach(contagem=>{const clone=template.content.cloneNode(!0);clone.querySelector('[data-cell="data"]').textContent=(new Date(contagem.created_at)).toLocaleString("pt-BR");clone.querySelector('[data-cell="responsavel"]').textContent=contagem.responsavel_nome;clone.querySelector('[data-cell="setor"]').textContent=contagem.setor_nome;clone.querySelector('[data-cell="itens"]').textContent=contagem.itens.length;clone.querySelector(".btn-visualizar").addEventListener("click",()=>showCountDetails(contagem.id));clone.querySelector(".btn-exportar").addEventListener("click",()=>handleExportTXT(contagem.id));tableBody.appendChild(clone)})}catch(error){alert(`Erro ao carregar hist√≥rico: ${error.message}`)}finally{hideLoader()}};
        const showCountDetails=async contagemId=>{showLoader();try{const{data:contagem,error}=await _supabaseClient.from("contagens").select("*").eq("id",contagemId).single();if(error)throw error;if(!contagem){alert("Contagem n√£o encontrada!");showScreen("screenDashboard");return}document.getElementById("visualizarContagemDetalhes").innerHTML=`<p><strong>Respons√°vel:</strong> ${contagem.responsavel_nome}</p><p><strong>Setor:</strong> ${contagem.setor_nome}</p><p><strong>Data e Hora:</strong> ${new Date(contagem.created_at).toLocaleString("pt-BR")}</p><hr><p><strong>Total de Tipos de Itens Contados:</strong> ${contagem.itens.length}</p>`;const tableBody=document.getElementById("tableContagemFinalizada").querySelector("tbody");tableBody.innerHTML="";contagem.itens.sort((a,b)=>a.nome.localeCompare(b.nome)).forEach(item=>{const categoria=categoriasCache.find(c=>c.id==item.categoria_id);tableBody.insertRow().innerHTML=`<td>${item.codigo}</td><td>${item.nome}</td><td>${categoria?categoria.nome:"N/A"}</td><td>${item.quantidade}</td>`});showScreen("screenVisualizarContagem")}catch(error){alert(`Erro ao carregar detalhes: ${error.message}`)}finally{hideLoader()}};
        const handleExportTXT=async contagemId=>{const{data:contagem,error}=await _supabaseClient.from("contagens").select("itens, created_at, setor_nome").eq("id",contagemId).single();if(error||!contagem){alert("Contagem n√£o encontrada para exportar.");return}const fileContent=contagem.itens.map(item=>`${item.codigo};${item.quantidade}`).join("\n"),date=new Date(contagem.created_at),dateString=`${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,"0")}-${String(date.getDate()).padStart(2,"0")}`,setorString=contagem.setor_nome.replace(/[^a-zA-Z0-9]/g,"_"),fileName=`Contagem_${dateString}_Setor_${setorString}.txt`,blob=new Blob([fileContent],{type:"text/plain;charset=utf-8"}),link=document.createElement("a");link.href=URL.createObjectURL(blob);link.download=fileName;document.body.appendChild(link);link.click();document.body.removeChild(link)};
        
    });
    </script>
</body>
</html>
