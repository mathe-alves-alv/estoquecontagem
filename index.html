<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Contagem de Estoque v7.0</title>
    <style>
        :root {
            --primary-color: #007bff; --success-color: #198754; --info-color: #0dcaf0; --danger-color: #dc3545; --background-color: #f4f6f9; --container-bg-color: #ffffff; --text-color: #212529; --border-color: #dee2e6; --border-radius: 0.375rem; --box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 10px 0; background-color: var(--background-color); color: var(--text-color); display: flex; flex-direction: column; align-items: center; min-height: 100vh; font-size: 16px; }
        .container { width: 95%; max-width: 800px; background-color: var(--container-bg-color); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); margin: 15px 0; border: 1px solid var(--border-color); }
        h1, h2, h3 { text-align: center; margin-top: 0; margin-bottom: 1.5rem; font-weight: 500; }
        h2 { font-size: 1.75rem; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeInView .4s; }
        @keyframes fadeInView { from { opacity: 0; } to { opacity: 1; } }
        button, .btn { border: 1px solid transparent; padding: .6rem 1rem; font-size: 1rem; border-radius: var(--border-radius); cursor: pointer; transition: background-color .15s; margin: .25rem; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-info { background-color: var(--info-color); color: black; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .dashboard-options { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; padding: 1rem 0; }
        .dashboard-options .btn { width: 100%; padding: 1rem; font-size: 1.05rem; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        th, td { border: 1px solid var(--border-color); padding: .6rem; text-align: left; word-break: break-word; }
        th { background-color: #f8f9fa; }
        input, select { width: 100%; padding: .7rem .75rem; margin-bottom: 1rem; border: 1px solid #ced4da; border-radius: var(--border-radius); box-sizing: border-box; font-size: 1rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: .5rem; font-weight: 500; }
        .card { border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: 1.5rem; box-shadow: var(--box-shadow); }
        .card-header { padding: .75rem 1.25rem; background-color: #f8f9fa; border-bottom: 1px solid var(--border-color); }
        .card-header h3 { margin: 0; font-size: 1.25rem; }
        .card-body { padding: 1.25rem; overflow-x: auto; }
        .form-inline { display: flex; gap: 1rem; align-items: flex-end; }
        #loginErrorMessage { color: var(--danger-color); margin-top: 1rem; text-align: center; display: none; }
        .table-actions button { margin: 0 2px; padding: .25rem .5rem; font-size: .85rem; }
        .back-button { margin-bottom: 1.5rem; display: inline-block; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal-content { background-color: white; padding: 25px; border-radius: var(--border-radius); width: 90%; max-width: 500px; }
        .modal-actions { margin-top: 1.5rem; text-align: right; }
        .admin-only { display: none; }

        /* --- MELHORIA VISUAL: Checkboxes --- */
        .setores-checkbox-group { max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: var(--border-radius); margin-bottom: 1rem; }
        .setores-checkbox-group label { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; }
        .setores-checkbox-group input[type="checkbox"] { width: auto; margin-bottom: 0; }

        @media (max-width: 600px) {
            .dashboard-options { grid-template-columns: 1fr; }
            .form-inline { flex-direction: column; align-items: stretch; }
            .table-actions { display: flex; flex-direction: column; gap: 5px; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div id="mainContainer" class="container">
        <div id="screenLogin" class="screen active">
            <h1>Login no Sistema</h1>
            <div class="card card-body">
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group" id="loginPasswordGroup">
                    <label for="loginPassword">Senha:</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button class="btn btn-primary" id="loginButton" style="width: 100%;">Entrar</button>
                <div id="loginErrorMessage"></div>
            </div>
        </div>

        <div id="screenDashboard" class="screen">
            <h2>Painel de Controle</h2>
            <p>Logado como: <strong id="userDisplay"></strong></p>
            <div class="dashboard-options">
                <button class="btn btn-primary" id="btnNavNovaContagem">‚ñ∂Ô∏è Iniciar Nova Contagem</button>
                <button class="btn btn-info" id="btnNavHistorico">üìÑ Hist√≥rico de Contagens</button>
                <button class="btn btn-secondary admin-only" id="btnNavProdutos">üì¶ Gerenciar Produtos</button>
                <button class="btn btn-secondary admin-only" id="btnNavCategorias">üè∑Ô∏è Gerenciar Categorias</button>
                <button class="btn btn-secondary admin-only" id="btnNavSetores">üè¢ Gerenciar Setores</button>
                <button class="btn btn-secondary admin-only" id="btnNavUsuarios">üë• Gerenciar Usu√°rios</button>
                <button class="btn btn-danger" id="btnLogout"> Sair</button>
            </div>
        </div>

        <div id="screenUsuarios" class="screen">
            <button class="btn btn-secondary back-button btn-back" data-target="screenDashboard">&larr; Voltar</button>
            <h2>Gerenciar Usu√°rios</h2>
            <div class="card"><div class="card-header"><h3>Adicionar Novo Usu√°rio</h3></div><div class="card-body"><form id="formAddUsuario"><div class="form-group"><label for="usuarioNome">Nome:</label><input type="text" id="usuarioNome" required></div><div class="form-group"><label for="usuarioEmail">Email (para login):</label><input type="email" id="usuarioEmail" required></div><div class="form-group"><label for="usuarioPassword">Senha:</label><input type="password" id="usuarioPassword" required></div><div class="form-group"><label for="usuarioRole">Fun√ß√£o:</label><select id="usuarioRole" required><option value="contador">Contador</option><option value="admin">Admin</option></select></div><div class="form-group"><label>Setores Permitidos:</label><div id="usuarioSetores" class="setores-checkbox-group"></div></div><button type="submit" class="btn btn-success">Adicionar Usu√°rio</button></form></div></div>
            <div class="card"><div class="card-header"><h3>Usu√°rios Cadastrados</h3></div><div class="card-body"><table id="tableUsuarios"><thead><tr><th>Nome</th><th>Email</th><th>Fun√ß√£o</th><th>Setores</th><th>A√ß√£o</th></tr></thead><tbody></tbody></table></div></div>
        </div>
        <div id="screenProdutos" class="screen">
            <button class="btn btn-secondary back-button btn-back" data-target="screenDashboard">&larr; Voltar</button>
            <h2>Gerenciar Produtos</h2>
            <div class="card"><div class="card-header"><h3>Adicionar Novo Produto</h3></div><div class="card-body"><form id="formAddProduto"><div class="form-group"><label for="produtoCodigo">C√≥digo:</label><input type="text" id="produtoCodigo" required></div><div class="form-group"><label for="produtoNome">Nome do Produto:</label><input type="text" id="produtoNome" required></div><div class="form-group"><label for="produtoCategoria">Categoria:</label><select id="produtoCategoria" required></select></div><div class="form-group"><label for="produtoSetor">Setor:</label><select id="produtoSetor" required></select></div><button type="submit" class="btn btn-success">Adicionar Produto</button></form></div></div>
            <div class="card"><div class="card-header"><h3>Produtos Cadastrados</h3></div><div class="card-body"><table id="tableProdutos"><thead><tr><th>C√≥digo</th><th>Nome</th><th>Categoria</th><th>Setor</th><th>A√ß√£o</th></tr></thead><tbody></tbody></table></div></div>
        </div>
        <div id="screenCategorias" class="screen">
            <button class="btn btn-secondary back-button btn-back" data-target="screenDashboard">&larr; Voltar</button>
            <h2>Gerenciar Categorias</h2>
            <div class="card"><div class="card-header"><h3>Adicionar Nova Categoria</h3></div><div class="card-body"><form id="formAddCategoria" class="form-inline"><div class="form-group" style="flex-grow: 1; margin: 0;"><label for="categoriaNome">Nome da Categoria:</label><input type="text" id="categoriaNome" required></div><button type="submit" class="btn btn-success">Adicionar</button></form></div></div>
            <div class="card"><div class="card-header"><h3>Categorias Cadastradas</h3></div><div class="card-body"><table id="tableCategorias"><thead><tr><th>Nome</th><th>A√ß√£o</th></tr></thead><tbody></tbody></table></div></div>
        </div>
        <div id="screenSetores" class="screen">
            <button class="btn btn-secondary back-button btn-back" data-target="screenDashboard">&larr; Voltar</button>
            <h2>Gerenciar Setores</h2>
            <div class="card"><div class="card-header"><h3>Adicionar Novo Setor</h3></div><div class="card-body"><form id="formAddSetor" class="form-inline"><div class="form-group" style="flex-grow: 1; margin: 0;"><label for="setorNome">Nome do Setor:</label><input type="text" id="setorNome" required></div><button type="submit" class="btn btn-success">Adicionar</button></form></div></div>
            <div class="card"><div class="card-header"><h3>Setores Cadastrados</h3></div><div class="card-body"><table id="tableSetores"><thead><tr><th>Nome</th><th>A√ß√£o</th></tr></thead><tbody></tbody></table></div></div>
        </div>
        <div id="screenNovaContagem" class="screen">
            <button class="btn btn-secondary back-button btn-back" data-target="screenDashboard">&larr; Voltar</button>
            <h2>Realizar Contagem de Estoque</h2>
            <div class="card card-body"><div class="form-group"><label for="contagemResponsavel">Respons√°vel:</label><input type="text" id="contagemResponsavel" disabled></div><div class="form-group"><label for="contagemSetor">Setor:</label><select id="contagemSetor" required></select></div><div class="form-group"><label for="contagemFiltroCategoria">Filtrar por Categoria:</label><select id="contagemFiltroCategoria"></select></div></div>
            <div class="card card-body"><table id="tableContagem"><thead><tr><th>C√≥digo</th><th>Produto</th><th>Qtd</th></tr></thead><tbody></tbody></table></div>
            <button class="btn btn-success" id="btnSalvarContagem" style="width: 100%; padding: 0.8rem; font-size: 1.2rem;">Salvar Contagem</button>
        </div>
        <div id="screenHistorico" class="screen">
            <button class="btn btn-secondary back-button btn-back" data-target="screenDashboard">&larr; Voltar</button>
            <h2>Hist√≥rico de Contagens</h2>
            <div class="card"><div class="card-header"><h3>Registros Salvos</h3></div><div class="card-body"><table id="tableHistorico"><thead><tr><th>Data</th><th>Respons√°vel</th><th>Setor</th><th>Itens</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table></div></div>
        </div>
        <div id="screenVisualizarContagem" class="screen">
            <button class="btn btn-secondary back-button btn-back" data-target="screenDashboard">&larr; Voltar ao Painel</button>
            <h2>Resumo da Contagem</h2>
            <div id="visualizarContagemDetalhes" class="card card-body"></div>
            <div class="card"><div class="card-header"><h3>Itens Contados</h3></div><div class="card-body"><table id="tableContagemFinalizada"><thead><tr><th>C√≥digo</th><th>Produto</th><th>Categoria</th><th>Qtd</th></tr></thead><tbody></tbody></table></div></div>
        </div>
    </div>
    
    <div id="modalEditProduto" class="modal-overlay">
        <div class="modal-content">
            <h3>Editar Produto</h3>
            <form id="formEditProduto">
                <input type="hidden" id="editProdutoId">
                <div class="form-group"><label for="editProdutoCodigo">C√≥digo:</label><input type="text" id="editProdutoCodigo" required></div>
                <div class="form-group"><label for="editProdutoNome">Nome do Produto:</label><input type="text" id="editProdutoNome" required></div>
                <div class="form-group"><label for="editProdutoCategoria">Categoria:</label><select id="editProdutoCategoria" required></select></div>
                <div class="form-group"><label for="editProdutoSetor">Setor:</label><select id="editProdutoSetor" required></select></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="btnCancelEdit">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>
    <template id="template-linha-simples"><tr><td data-cell="nome"></td><td class="table-actions"><button class="btn btn-danger btn-deletar">Excluir</button></td></tr></template>
    <template id="template-linha-produto"><tr><td data-cell="codigo"></td><td data-cell="nome"></td><td data-cell="categoria"></td><td data-cell="setor"></td><td class="table-actions"><button class="btn btn-info btn-editar">Editar</button><button class="btn btn-danger btn-deletar">Excluir</button></td></tr></template>
    <template id="template-linha-historico"><tr><td data-cell="data"></td><td data-cell="responsavel"></td><td data-cell="setor"></td><td data-cell="itens"></td><td class="table-actions"><button class="btn btn-primary btn-visualizar">Visualizar</button><button class="btn btn-success btn-exportar">Baixar TXT</button></td></tr></template>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const db = {
            _getData: (key) => JSON.parse(localStorage.getItem(key)) || [],
            _saveData: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
            get: (entity) => db._getData(entity),
            save: (entity, data) => db._saveData(entity, data),
            init: () => {
                const keys = ['categorias', 'setores', 'produtos', 'contagens', 'users'];
                keys.forEach(key => { if (!localStorage.getItem(key)) { db._saveData(key, []); } });
                if (db.get('users').length === 0) {
                    // ATUALIZA√á√ÉO: Suas credenciais de admin e um contador padr√£o
                    db.save('users', [
                        { id: Date.now(), nome: 'Matheus (Admin)', email: 'matheus@holysalt.com', password: '260195', role: 'admin', setorIds: [] },
                        { id: Date.now() + 1, nome: 'Jo√£o Contador', email: 'joao@email.com', password: '', role: 'contador', setorIds: [] }
                    ]);
                }
            }
        };

        db.init();
        let currentUser = null;

        const screens = document.querySelectorAll('.screen');
        const showScreen = (screenId) => {
            screens.forEach(s => s.classList.remove('active'));
            document.getElementById(screenId)?.classList.add('active');
            window.scrollTo(0, 0);
        };

        // --- L√ìGICA DE LOGIN COM FUN√á√ïES (ALTERADA) ---
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordGroup = document.getElementById('loginPasswordGroup');
        const loginButton = document.getElementById('loginButton');
        const loginErrorMessage = document.getElementById('loginErrorMessage');

        // NOVO: Verifica o email digitado para mostrar ou esconder o campo de senha
        loginEmailInput.addEventListener('input', () => {
            const email = loginEmailInput.value.trim().toLowerCase();
            const users = db.get('users');
            const user = users.find(u => u.email.toLowerCase() === email);
            
            if (user && user.role === 'contador') {
                loginPasswordGroup.style.display = 'none';
            } else {
                loginPasswordGroup.style.display = 'block';
            }
        });
        
        loginButton.addEventListener('click', () => {
            const email = loginEmailInput.value.trim().toLowerCase();
            const pass = document.getElementById('loginPassword').value;
            const users = db.get('users');
            const foundUser = users.find(u => u.email.toLowerCase() === email);

            loginErrorMessage.style.display = 'none';

            if (!foundUser) {
                loginErrorMessage.textContent = "Email n√£o encontrado.";
                loginErrorMessage.style.display = 'block';
                return;
            }

            // L√≥gica de login separada por fun√ß√£o
            let canLogin = false;
            if (foundUser.role === 'admin') {
                if (foundUser.password === pass) {
                    canLogin = true;
                } else {
                    loginErrorMessage.textContent = "Senha incorreta para o admin.";
                    loginErrorMessage.style.display = 'block';
                }
            } else if (foundUser.role === 'contador') {
                // Contador n√£o precisa de senha
                canLogin = true;
            }

            if (canLogin) {
                currentUser = foundUser;
                document.getElementById('userDisplay').textContent = currentUser.nome;
                updateUIForRole();
                showScreen('screenDashboard');
            }
        });

        // --- L√ìGICA DE NAVEGA√á√ÉO E PERMISS√ïES ---
        const updateUIForRole = () => {
            const isAdmin = currentUser && currentUser.role === 'admin';
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = isAdmin ? 'block' : 'none';
            });
        };

        document.getElementById('btnLogout').addEventListener('click', () => {
            currentUser = null;
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            loginPasswordGroup.style.display = 'block'; // Garante que a senha apare√ßa ao deslogar
            showScreen('screenLogin');
        });
        
        document.querySelectorAll('.btn-back').forEach(button => {
            button.addEventListener('click', () => showScreen(button.dataset.target));
        });

        // (O restante do c√≥digo permanece o mesmo da vers√£o anterior)
        // ...
        document.getElementById('btnNavProdutos').addEventListener('click', () => { renderProdutoTable(); populateCategoriaDropdown(document.getElementById('produtoCategoria')); populateSetorDropdown(document.getElementById('produtoSetor')); showScreen('screenProdutos'); });
        document.getElementById('btnNavCategorias').addEventListener('click', () => { renderSimpleTable('categorias', document.getElementById('tableCategorias').querySelector('tbody')); showScreen('screenCategorias'); });
        document.getElementById('btnNavSetores').addEventListener('click', () => { renderSimpleTable('setores', document.getElementById('tableSetores').querySelector('tbody')); showScreen('screenSetores'); });
        document.getElementById('btnNavUsuarios').addEventListener('click', () => { renderUsuarioTable(); populateSetorCheckboxes(document.getElementById('usuarioSetores')); showScreen('screenUsuarios'); });
        document.getElementById('btnNavNovaContagem').addEventListener('click', () => { startNewCount(); showScreen('screenNovaContagem'); });
        document.getElementById('btnNavHistorico').addEventListener('click', () => { renderHistoricoTable(); showScreen('screenHistorico'); });

        const populateSetorCheckboxes = (container, selectedIds = []) => {
            const setores = db.get('setores');
            container.innerHTML = '';
            if (setores.length === 0) { container.innerHTML = 'Nenhum setor cadastrado.'; return; }
            setores.sort((a,b)=> a.nome.localeCompare(b.nome)).forEach(setor => {
                const checked = selectedIds.includes(setor.id) ? 'checked' : '';
                container.innerHTML += `<label><input type="checkbox" value="${setor.id}" ${checked}> ${setor.nome}</label>`;
            });
        };

        const renderUsuarioTable = () => {
            const users = db.get('users');
            const setores = db.get('setores');
            const tableBody = document.getElementById('tableUsuarios').querySelector('tbody');
            tableBody.innerHTML = '';
            users.sort((a,b)=> a.nome.localeCompare(b.nome)).forEach(user => {
                const setorNomes = user.setorIds.map(id => setores.find(s => s.id === id)?.nome).filter(Boolean).join(', ') || 'N/A';
                const row = tableBody.insertRow();
                row.innerHTML = `<td>${user.nome}</td><td>${user.email}</td><td>${user.role}</td><td>${setorNomes}</td><td class="table-actions"><button class="btn btn-danger" data-id="${user.id}">Excluir</button></td>`;
                row.querySelector('.btn-danger').addEventListener('click', (e) => {
                    const idToDelete = parseInt(e.target.dataset.id, 10);
                    if (idToDelete === currentUser.id) { alert("Voc√™ n√£o pode excluir a si mesmo."); return; }
                    if (confirm(`Tem certeza que deseja excluir o usu√°rio "${user.nome}"?`)) {
                        const newUsers = db.get('users').filter(u => u.id !== idToDelete);
                        db.save('users', newUsers);
                        renderUsuarioTable();
                    }
                });
            });
        };

        document.getElementById('formAddUsuario').addEventListener('submit', (e) => {
            e.preventDefault();
            const nome = document.getElementById('usuarioNome').value.trim();
            const email = document.getElementById('usuarioEmail').value.trim().toLowerCase();
            const password = document.getElementById('usuarioPassword').value;
            const role = document.getElementById('usuarioRole').value;
            const setorIds = Array.from(document.querySelectorAll('#usuarioSetores input:checked')).map(cb => parseInt(cb.value, 10));
            const users = db.get('users');
            if (users.some(u => u.email === email)) { alert('Este email j√° est√° em uso.'); return; }
            users.push({ id: Date.now(), nome, email, password, role, setorIds });
            db.save('users', users);
            e.target.reset();
            populateSetorCheckboxes(document.getElementById('usuarioSetores'));
            renderUsuarioTable();
        });

        const renderSimpleTable = (entity, tableBody) => {
            const data = db.get(entity);
            const template = document.getElementById('template-linha-simples');
            tableBody.innerHTML = '';
            if (data.length === 0) { tableBody.innerHTML = `<tr><td colspan="2">Nenhum item cadastrado.</td></tr>`; return; }
            data.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(item => {
                const clone = template.content.cloneNode(true);
                clone.querySelector('[data-cell="nome"]').textContent = item.nome;
                clone.querySelector('.btn-deletar').addEventListener('click', () => {
                    if (confirm(`Tem certeza que deseja excluir "${item.nome}"?`)) {
                        const newData = db.get(entity).filter(d => d.id !== item.id);
                        db.save(entity, newData);
                        renderSimpleTable(entity, tableBody);
                    }
                });
                tableBody.appendChild(clone);
            });
        };

        const setupSimpleForm = (formId, inputId, entity, tableBody) => {
            document.getElementById(formId).addEventListener('submit', (e) => {
                e.preventDefault();
                const input = document.getElementById(inputId);
                const nome = input.value.trim();
                if (!nome) return;
                const data = db.get(entity);
                if (data.some(item => item.nome.toLowerCase() === nome.toLowerCase())) { alert(`O item "${nome}" j√° est√° cadastrado.`); return; }
                data.push({ id: Date.now(), nome: nome });
                db.save(entity, data);
                input.value = '';
                renderSimpleTable(entity, tableBody);
            });
        };
        
        setupSimpleForm('formAddCategoria', 'categoriaNome', 'categorias', document.getElementById('tableCategorias').querySelector('tbody'));
        setupSimpleForm('formAddSetor', 'setorNome', 'setores', document.getElementById('tableSetores').querySelector('tbody'));

        const populateDropdown = (selectElement, data, placeholder) => {
            selectElement.innerHTML = `<option value="">-- ${placeholder} --</option>`;
            data.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(item => {
                selectElement.innerHTML += `<option value="${item.id}">${item.nome}</option>`;
            });
        };
        const populateCategoriaDropdown = (elem) => populateDropdown(elem, db.get('categorias'), 'Selecione a Categoria');
        const populateSetorDropdown = (elem) => populateDropdown(elem, db.get('setores'), 'Selecione o Setor');

        const renderProdutoTable = () => {
            const produtos = db.get('produtos');
            const categorias = db.get('categorias');
            const setores = db.get('setores');
            const tableBody = document.getElementById('tableProdutos').querySelector('tbody');
            const template = document.getElementById('template-linha-produto');
            tableBody.innerHTML = '';
            if (produtos.length === 0) { tableBody.innerHTML = `<tr><td colspan="5">Nenhum produto cadastrado.</td></tr>`; return; }
            produtos.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(prod => {
                const categoria = categorias.find(c => c.id == prod.categoriaId);
                const setor = setores.find(s => s.id == prod.setorId);
                const clone = template.content.cloneNode(true);
                clone.querySelector('[data-cell="codigo"]').textContent = prod.codigo;
                clone.querySelector('[data-cell="nome"]').textContent = prod.nome;
                clone.querySelector('[data-cell="categoria"]').textContent = categoria ? categoria.nome : 'N/A';
                clone.querySelector('[data-cell="setor"]').textContent = setor ? setor.nome : 'N/A';
                clone.querySelector('.btn-editar').addEventListener('click', () => openEditModal(prod.id));
                clone.querySelector('.btn-deletar').addEventListener('click', () => {
                    if (confirm(`Tem certeza que deseja excluir o produto "${prod.nome}"?`)) {
                        db.save('produtos', db.get('produtos').filter(p => p.id !== prod.id));
                        renderProdutoTable();
                    }
                });
                tableBody.appendChild(clone);
            });
        };

        document.getElementById('formAddProduto').addEventListener('submit', (e) => {
            e.preventDefault();
            const codigo = document.getElementById('produtoCodigo').value.trim();
            const nome = document.getElementById('produtoNome').value.trim();
            const categoriaId = document.getElementById('produtoCategoria').value;
            const setorId = document.getElementById('produtoSetor').value;
            if (!codigo || !nome || !categoriaId || !setorId) return alert("Todos os campos s√£o obrigat√≥rios.");
            const produtos = db.get('produtos');
            if (produtos.some(p => p.codigo.toLowerCase() === codigo.toLowerCase())) return alert(`O c√≥digo "${codigo}" j√° est√° cadastrado.`);
            produtos.push({ id: Date.now(), codigo, nome, categoriaId: parseInt(categoriaId), setorId: parseInt(setorId) });
            db.save('produtos', produtos);
            e.target.reset();
            renderProdutoTable();
        });

        const modal = document.getElementById('modalEditProduto');
        const openEditModal = (produtoId) => {
            const produto = db.get('produtos').find(p => p.id === produtoId);
            if (!produto) return;
            populateCategoriaDropdown(document.getElementById('editProdutoCategoria'));
            populateSetorDropdown(document.getElementById('editProdutoSetor'));
            document.getElementById('editProdutoId').value = produto.id;
            document.getElementById('editProdutoCodigo').value = produto.codigo;
            document.getElementById('editProdutoNome').value = produto.nome;
            document.getElementById('editProdutoCategoria').value = produto.categoriaId;
            document.getElementById('editProdutoSetor').value = produto.setorId;
            modal.classList.add('active');
        };
        const closeEditModal = () => modal.classList.remove('active');
        document.getElementById('btnCancelEdit').addEventListener('click', closeEditModal);
        document.getElementById('formEditProduto').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = parseInt(document.getElementById('editProdutoId').value);
            const codigo = document.getElementById('editProdutoCodigo').value.trim();
            const nome = document.getElementById('editProdutoNome').value.trim();
            const categoriaId = parseInt(document.getElementById('editProdutoCategoria').value);
            const setorId = parseInt(document.getElementById('editProdutoSetor').value);
            if (!codigo || !nome || !categoriaId || !setorId) return alert("Todos os campos s√£o obrigat√≥rios.");
            const produtos = db.get('produtos');
            const produtoIndex = produtos.findIndex(p => p.id === id);
            if (produtoIndex === -1) return;
            if (produtos.some(p => p.codigo.toLowerCase() === codigo.toLowerCase() && p.id !== id)) return alert(`O c√≥digo "${codigo}" j√° pertence a outro produto.`);
            produtos[produtoIndex] = { id, codigo, nome, categoriaId, setorId };
            db.save('produtos', produtos);
            renderProdutoTable();
            closeEditModal();
        });

        const startNewCount = () => {
            document.getElementById('contagemResponsavel').value = currentUser.nome;
            const setorSelect = document.getElementById('contagemSetor');
            const catFiltroSelect = document.getElementById('contagemFiltroCategoria');
            const setores = db.get('setores');
            setorSelect.innerHTML = '<option value="">-- Selecione um setor --</option>';
            const setoresPermitidos = currentUser.role === 'admin' ? setores : setores.filter(s => currentUser.setorIds.includes(s.id));
            setoresPermitidos.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(s => setorSelect.innerHTML += `<option value="${s.id}">${s.nome}</option>`);
            populateDropdown(catFiltroSelect, db.get('categorias'), 'Filtrar por Categoria');
            catFiltroSelect.insertAdjacentHTML('afterbegin', '<option value="todos">Todas as Categorias</option>');
            catFiltroSelect.value = "todos";
            const tableBody = document.getElementById('tableContagem').querySelector('tbody');
            tableBody.innerHTML = '';
            db.get('produtos').sort((a, b) => a.nome.localeCompare(b.nome)).forEach(prod => { const row = tableBody.insertRow(); row.dataset.categoriaId = prod.categoriaId; row.innerHTML = `<td>${prod.codigo}</td><td>${prod.nome}</td><td><input type="number" min="0" class="input-quantidade" data-produto-id="${prod.id}" placeholder="0"></td>`; });
        };

        const handleSaveCount = () => {
            if (!currentUser) { alert("Erro: Usu√°rio n√£o identificado."); return; }
            const setorId = parseInt(document.getElementById('contagemSetor').value);
            if (!setorId) { alert("Por favor, selecione o setor."); return; }
            const setor = db.get('setores').find(s => s.id === setorId);
            const itensContados = [];
            document.querySelectorAll('#tableContagem .input-quantidade').forEach(input => {
                const quantidade = parseInt(input.value, 10) || 0;
                const produto = db.get('produtos').find(p => p.id == input.dataset.produtoId);
                if (produto) itensContados.push({ ...produto, quantidade });
            });
            const novaContagem = { id: Date.now(), data: new Date().toISOString(), responsavelId: currentUser.id, responsavelNome: currentUser.nome, setorId: setorId, setorNome: setor.nome, itens: itensContados.sort((a,b) => a.nome.localeCompare(b.nome)) };
            db.save('contagens', [...db.get('contagens'), novaContagem]);
            alert("Contagem salva com sucesso!");
            showCountDetails(novaContagem.id);
        };
        document.getElementById('btnSalvarContagem').addEventListener('click', handleSaveCount);

        document.getElementById('contagemFiltroCategoria').addEventListener('change', (e) => { const catId = e.target.value; document.getElementById('tableContagem').querySelectorAll('tbody tr').forEach(row => { row.style.display = (catId === 'todos' || row.dataset.categoriaId === catId) ? '' : 'none'; }); });

        const renderHistoricoTable = () => {
            let contagens = db.get("contagens").sort((a, b) => b.data.localeCompare(a.data));
            if (currentUser.role === "contador") {
                contagens = contagens.filter(c => currentUser.setorIds.includes(c.setorId));
            }
            const tableBody = document.getElementById("tableHistorico").querySelector("tbody");
            const template = document.getElementById("template-linha-historico");
            tableBody.innerHTML = "";
            if (contagens.length === 0) { tableBody.innerHTML = `<tr><td colspan="5">Nenhuma contagem registrada para seus setores.</td></tr>`; return; }
            contagens.forEach(contagem => { const clone = template.content.cloneNode(true); clone.querySelector('[data-cell="data"]').textContent = new Date(contagem.data).toLocaleString("pt-BR"); clone.querySelector('[data-cell="responsavel"]').textContent = contagem.responsavelNome; clone.querySelector('[data-cell="setor"]').textContent = contagem.setorNome; clone.querySelector('[data-cell="itens"]').textContent = contagem.itens.length; clone.querySelector(".btn-visualizar").addEventListener("click", () => showCountDetails(contagem.id)); clone.querySelector(".btn-exportar").addEventListener("click", () => handleExportTXT(contagem.id)); tableBody.appendChild(clone); });
        };
        
        const showCountDetails = (contagemId) => { const contagem = db.get('contagens').find(c => c.id == contagemId); if (!contagem) { alert("Contagem n√£o encontrada!"); showScreen('screenDashboard'); return; } document.getElementById('visualizarContagemDetalhes').innerHTML = `<p><strong>Respons√°vel:</strong> ${contagem.responsavelNome}</p><p><strong>Setor:</strong> ${contagem.setorNome}</p><p><strong>Data e Hora:</strong> ${new Date(contagem.data).toLocaleString('pt-BR')}</p><hr><p><strong>Total de Tipos de Itens Contados:</strong> ${contagem.itens.length}</p>`; const tableBody = document.getElementById('tableContagemFinalizada').querySelector('tbody'), categorias = db.get('categorias'); tableBody.innerHTML = ''; contagem.itens.forEach(item => { const categoria = categorias.find(c => c.id == item.categoriaId); tableBody.insertRow().innerHTML = `<td>${item.codigo}</td><td>${item.nome}</td><td>${categoria ? categoria.nome : 'N/A'}</td><td>${item.quantidade}</td>`; }); showScreen('screenVisualizarContagem'); };
        
        const handleExportTXT = (contagemId) => { const contagem = db.get('contagens').find(c => c.id == contagemId); if (!contagem) { alert("Contagem n√£o encontrada para exportar."); return; } const fileContent = contagem.itens.map(item => `${item.codigo};${item.quantidade}`).join('\n'); const date = new Date(contagem.data); const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`; const setorString = contagem.setorNome.replace(/[^a-zA-Z0-9]/g, '_'); const fileName = `Contagem_${dateString}_Setor_${setorString}.txt`; const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = fileName; document.body.appendChild(link); link.click(); document.body.removeChild(link); };

    });
    </script>
</body>
</html>
